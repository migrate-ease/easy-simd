#define EASYSIMD_TEST_X86_AVX512_INSN roundscale_round

#include <test/x86/avx512/test-avx512.h>
#include <easysimd/x86/avx512/roundscale_round.h>
#include <easysimd/x86/avx512/setzero.h>

static int
test_easysimd_mm512_roundscale_round_ps (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float32 a[16];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float32 r[16];
  } test_vec[] = {
    { { EASYSIMD_FLOAT32_C(   420.36), EASYSIMD_FLOAT32_C(  -392.69), EASYSIMD_FLOAT32_C(    92.54), EASYSIMD_FLOAT32_C(  -516.66),
        EASYSIMD_FLOAT32_C(  -461.28), EASYSIMD_FLOAT32_C(   334.68), EASYSIMD_FLOAT32_C(  -795.62), EASYSIMD_FLOAT32_C(   457.56),
        EASYSIMD_FLOAT32_C(   838.71), EASYSIMD_FLOAT32_C(  -818.44), EASYSIMD_FLOAT32_C(  -257.99), EASYSIMD_FLOAT32_C(   715.11),
        EASYSIMD_FLOAT32_C(   338.10), EASYSIMD_FLOAT32_C(   349.70), EASYSIMD_FLOAT32_C(  -986.91), EASYSIMD_FLOAT32_C(   385.06) },
       INT32_C(         128),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(   420.36), EASYSIMD_FLOAT32_C(  -392.69), EASYSIMD_FLOAT32_C(    92.54), EASYSIMD_FLOAT32_C(  -516.66),
        EASYSIMD_FLOAT32_C(  -461.28), EASYSIMD_FLOAT32_C(   334.68), EASYSIMD_FLOAT32_C(  -795.62), EASYSIMD_FLOAT32_C(   457.56),
        EASYSIMD_FLOAT32_C(   838.71), EASYSIMD_FLOAT32_C(  -818.44), EASYSIMD_FLOAT32_C(  -257.99), EASYSIMD_FLOAT32_C(   715.11),
        EASYSIMD_FLOAT32_C(   338.10), EASYSIMD_FLOAT32_C(   349.70), EASYSIMD_FLOAT32_C(  -986.91), EASYSIMD_FLOAT32_C(   385.06) } },
    { { EASYSIMD_FLOAT32_C(  -102.50),     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   610.23), EASYSIMD_FLOAT32_C(   712.54),
        EASYSIMD_FLOAT32_C(  -668.49), EASYSIMD_FLOAT32_C(   752.35), EASYSIMD_FLOAT32_C(  -528.74), EASYSIMD_FLOAT32_C(   -20.66),
        EASYSIMD_FLOAT32_C(  -980.81), EASYSIMD_FLOAT32_C(  -208.53), EASYSIMD_FLOAT32_C(  -940.25), EASYSIMD_FLOAT32_C(   895.60),
        EASYSIMD_FLOAT32_C(  -788.17), EASYSIMD_FLOAT32_C(  -332.94), EASYSIMD_FLOAT32_C(   -11.86), EASYSIMD_FLOAT32_C(  -304.83) },
       INT32_C(          65),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -102.50),     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   610.19), EASYSIMD_FLOAT32_C(   712.50),
        EASYSIMD_FLOAT32_C(  -668.50), EASYSIMD_FLOAT32_C(   752.31), EASYSIMD_FLOAT32_C(  -528.75), EASYSIMD_FLOAT32_C(   -20.69),
        EASYSIMD_FLOAT32_C(  -980.81), EASYSIMD_FLOAT32_C(  -208.56), EASYSIMD_FLOAT32_C(  -940.25), EASYSIMD_FLOAT32_C(   895.56),
        EASYSIMD_FLOAT32_C(  -788.19), EASYSIMD_FLOAT32_C(  -333.00), EASYSIMD_FLOAT32_C(   -11.88), EASYSIMD_FLOAT32_C(  -304.88) } },
    { { EASYSIMD_FLOAT32_C(    81.11),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   876.65), EASYSIMD_FLOAT32_C(  -580.79),
        EASYSIMD_FLOAT32_C(  -244.95), EASYSIMD_FLOAT32_C(   889.73), EASYSIMD_FLOAT32_C(   804.27), EASYSIMD_FLOAT32_C(  -859.60),
        EASYSIMD_FLOAT32_C(   948.64), EASYSIMD_FLOAT32_C(  -574.10), EASYSIMD_FLOAT32_C(    37.90), EASYSIMD_FLOAT32_C(  -975.20),
        EASYSIMD_FLOAT32_C(  -963.86), EASYSIMD_FLOAT32_C(  -249.56), EASYSIMD_FLOAT32_C(  -643.68), EASYSIMD_FLOAT32_C(   788.49) },
       INT32_C(         226),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(    81.11),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   876.65), EASYSIMD_FLOAT32_C(  -580.79),
        EASYSIMD_FLOAT32_C(  -244.95), EASYSIMD_FLOAT32_C(   889.73), EASYSIMD_FLOAT32_C(   804.27), EASYSIMD_FLOAT32_C(  -859.60),
        EASYSIMD_FLOAT32_C(   948.64), EASYSIMD_FLOAT32_C(  -574.10), EASYSIMD_FLOAT32_C(    37.90), EASYSIMD_FLOAT32_C(  -975.20),
        EASYSIMD_FLOAT32_C(  -963.86), EASYSIMD_FLOAT32_C(  -249.56), EASYSIMD_FLOAT32_C(  -643.68), EASYSIMD_FLOAT32_C(   788.49) } },
    { {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -775.00), EASYSIMD_FLOAT32_C(  -937.53), EASYSIMD_FLOAT32_C(  -308.58),
        EASYSIMD_FLOAT32_C(   -79.83), EASYSIMD_FLOAT32_C(   268.25), EASYSIMD_FLOAT32_C(    14.24), EASYSIMD_FLOAT32_C(   819.73),
        EASYSIMD_FLOAT32_C(   931.60), EASYSIMD_FLOAT32_C(   175.77), EASYSIMD_FLOAT32_C(   -99.16), EASYSIMD_FLOAT32_C(   336.95),
        EASYSIMD_FLOAT32_C(    52.42), EASYSIMD_FLOAT32_C(   320.05), EASYSIMD_FLOAT32_C(  -908.00), EASYSIMD_FLOAT32_C(   -57.85) },
       INT32_C(         243),
       INT32_C(           8),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -775.00), EASYSIMD_FLOAT32_C(  -937.53), EASYSIMD_FLOAT32_C(  -308.58),
        EASYSIMD_FLOAT32_C(   -79.83), EASYSIMD_FLOAT32_C(   268.25), EASYSIMD_FLOAT32_C(    14.24), EASYSIMD_FLOAT32_C(   819.73),
        EASYSIMD_FLOAT32_C(   931.60), EASYSIMD_FLOAT32_C(   175.77), EASYSIMD_FLOAT32_C(   -99.16), EASYSIMD_FLOAT32_C(   336.95),
        EASYSIMD_FLOAT32_C(    52.42), EASYSIMD_FLOAT32_C(   320.05), EASYSIMD_FLOAT32_C(  -908.00), EASYSIMD_FLOAT32_C(   -57.85) } },
    { { EASYSIMD_FLOAT32_C(   270.29), EASYSIMD_FLOAT32_C(   -84.41), EASYSIMD_FLOAT32_C(   586.36), EASYSIMD_FLOAT32_C(  -979.27),
        EASYSIMD_FLOAT32_C(   271.91), EASYSIMD_FLOAT32_C(   374.85), EASYSIMD_FLOAT32_C(   242.43), EASYSIMD_FLOAT32_C(  -392.43),
        EASYSIMD_FLOAT32_C(   182.52), EASYSIMD_FLOAT32_C(   255.60), EASYSIMD_FLOAT32_C(  -997.03), EASYSIMD_FLOAT32_C(  -114.21),
        EASYSIMD_FLOAT32_C(   480.61), EASYSIMD_FLOAT32_C(  -934.56), EASYSIMD_FLOAT32_C(   577.21), EASYSIMD_FLOAT32_C(  -599.22) },
       INT32_C(          68),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   270.31), EASYSIMD_FLOAT32_C(   -84.44), EASYSIMD_FLOAT32_C(   586.38), EASYSIMD_FLOAT32_C(  -979.25),
        EASYSIMD_FLOAT32_C(   271.94), EASYSIMD_FLOAT32_C(   374.88), EASYSIMD_FLOAT32_C(   242.44), EASYSIMD_FLOAT32_C(  -392.44),
        EASYSIMD_FLOAT32_C(   182.50), EASYSIMD_FLOAT32_C(   255.62), EASYSIMD_FLOAT32_C(  -997.00), EASYSIMD_FLOAT32_C(  -114.19),
        EASYSIMD_FLOAT32_C(   480.62), EASYSIMD_FLOAT32_C(  -934.56), EASYSIMD_FLOAT32_C(   577.19), EASYSIMD_FLOAT32_C(  -599.25) } },
    { {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   767.22), EASYSIMD_FLOAT32_C(   121.34), EASYSIMD_FLOAT32_C(  -397.76),
        EASYSIMD_FLOAT32_C(  -180.36), EASYSIMD_FLOAT32_C(  -558.61), EASYSIMD_FLOAT32_C(  -305.76), EASYSIMD_FLOAT32_C(   761.79),
        EASYSIMD_FLOAT32_C(   565.70), EASYSIMD_FLOAT32_C(   -73.36), EASYSIMD_FLOAT32_C(  -347.42), EASYSIMD_FLOAT32_C(   115.93),
        EASYSIMD_FLOAT32_C(  -803.07), EASYSIMD_FLOAT32_C(   568.17), EASYSIMD_FLOAT32_C(  -297.71), EASYSIMD_FLOAT32_C(  -782.34) },
       INT32_C(          16),
       INT32_C(           4),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   767.00), EASYSIMD_FLOAT32_C(   121.50), EASYSIMD_FLOAT32_C(  -398.00),
        EASYSIMD_FLOAT32_C(  -180.50), EASYSIMD_FLOAT32_C(  -558.50), EASYSIMD_FLOAT32_C(  -306.00), EASYSIMD_FLOAT32_C(   762.00),
        EASYSIMD_FLOAT32_C(   565.50), EASYSIMD_FLOAT32_C(   -73.50), EASYSIMD_FLOAT32_C(  -347.50), EASYSIMD_FLOAT32_C(   116.00),
        EASYSIMD_FLOAT32_C(  -803.00), EASYSIMD_FLOAT32_C(   568.00), EASYSIMD_FLOAT32_C(  -297.50), EASYSIMD_FLOAT32_C(  -782.50) } },
    { { EASYSIMD_FLOAT32_C(   259.65),     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   450.62), EASYSIMD_FLOAT32_C(  -854.55),
        EASYSIMD_FLOAT32_C(  -803.69), EASYSIMD_FLOAT32_C(   516.07), EASYSIMD_FLOAT32_C(   722.66), EASYSIMD_FLOAT32_C(  -402.91),
        EASYSIMD_FLOAT32_C(  -150.24), EASYSIMD_FLOAT32_C(  -685.89), EASYSIMD_FLOAT32_C(  -182.41), EASYSIMD_FLOAT32_C(  -884.95),
        EASYSIMD_FLOAT32_C(  -918.68), EASYSIMD_FLOAT32_C(   938.93), EASYSIMD_FLOAT32_C(  -282.71), EASYSIMD_FLOAT32_C(   -99.04) },
       INT32_C(         209),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(   259.65),     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   450.62), EASYSIMD_FLOAT32_C(  -854.55),
        EASYSIMD_FLOAT32_C(  -803.69), EASYSIMD_FLOAT32_C(   516.07), EASYSIMD_FLOAT32_C(   722.66), EASYSIMD_FLOAT32_C(  -402.91),
        EASYSIMD_FLOAT32_C(  -150.24), EASYSIMD_FLOAT32_C(  -685.89), EASYSIMD_FLOAT32_C(  -182.41), EASYSIMD_FLOAT32_C(  -884.95),
        EASYSIMD_FLOAT32_C(  -918.68), EASYSIMD_FLOAT32_C(   938.93), EASYSIMD_FLOAT32_C(  -282.71), EASYSIMD_FLOAT32_C(   -99.04) } },
    { {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(    61.95), EASYSIMD_FLOAT32_C(  -464.91), EASYSIMD_FLOAT32_C(  -116.51),
        EASYSIMD_FLOAT32_C(   764.24), EASYSIMD_FLOAT32_C(  -247.25), EASYSIMD_FLOAT32_C(   723.58), EASYSIMD_FLOAT32_C(   841.37),
        EASYSIMD_FLOAT32_C(  -787.15), EASYSIMD_FLOAT32_C(   171.22), EASYSIMD_FLOAT32_C(   101.02), EASYSIMD_FLOAT32_C(   -71.45),
        EASYSIMD_FLOAT32_C(  -378.15), EASYSIMD_FLOAT32_C(   246.47), EASYSIMD_FLOAT32_C(   124.86), EASYSIMD_FLOAT32_C(  -862.09) },
       INT32_C(         146),
       INT32_C(           8),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(    61.95), EASYSIMD_FLOAT32_C(  -464.91), EASYSIMD_FLOAT32_C(  -116.51),
        EASYSIMD_FLOAT32_C(   764.24), EASYSIMD_FLOAT32_C(  -247.25), EASYSIMD_FLOAT32_C(   723.58), EASYSIMD_FLOAT32_C(   841.37),
        EASYSIMD_FLOAT32_C(  -787.15), EASYSIMD_FLOAT32_C(   171.22), EASYSIMD_FLOAT32_C(   101.02), EASYSIMD_FLOAT32_C(   -71.45),
        EASYSIMD_FLOAT32_C(  -378.15), EASYSIMD_FLOAT32_C(   246.47), EASYSIMD_FLOAT32_C(   124.86), EASYSIMD_FLOAT32_C(  -862.09) } },
  };

  easysimd__m512 a, r;

  a = easysimd_mm512_loadu_ps(test_vec[0].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(         128), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[0].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[1].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(          65), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[1].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[2].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(         226), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[2].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[3].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(         243), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[3].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[4].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(          68), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[4].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[5].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(          16), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[5].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[6].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(         209), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[6].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[7].a);
  r = easysimd_mm512_roundscale_round_ps(a, INT32_C(         146), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512 a = easysimd_test_x86_random_f32x16(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        a = easysimd_mm512_mask_mov_ps(a, 1, easysimd_mm512_set1_ps(EASYSIMD_MATH_NANF));
      else {
        if((easysimd_test_codegen_rand() & 1))
          a = easysimd_mm512_mask_mov_ps(a, 2, easysimd_mm512_set1_ps(EASYSIMD_MATH_INFINITY));
        else
          a = easysimd_mm512_mask_mov_ps(a, 2, easysimd_mm512_set1_ps(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION: EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m512 r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm512_roundscale_round_ps, r, easysimd_mm512_setzero_ps(), imm8, sae, a);

    easysimd_test_x86_write_f32x16(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x16(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_mask_roundscale_round_ps (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float32 src[16];
    const easysimd__mmask8 k;
    const easysimd_float32 a[16];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float32 r[16];
  } test_vec[] = {
    { { EASYSIMD_FLOAT32_C(  -683.72), EASYSIMD_FLOAT32_C(   458.47), EASYSIMD_FLOAT32_C(  -593.60), EASYSIMD_FLOAT32_C(   433.99),
        EASYSIMD_FLOAT32_C(   507.21), EASYSIMD_FLOAT32_C(  -748.26), EASYSIMD_FLOAT32_C(   930.02), EASYSIMD_FLOAT32_C(   211.45),
        EASYSIMD_FLOAT32_C(   545.03), EASYSIMD_FLOAT32_C(   396.72), EASYSIMD_FLOAT32_C(   252.12), EASYSIMD_FLOAT32_C(  -162.44),
        EASYSIMD_FLOAT32_C(  -909.04), EASYSIMD_FLOAT32_C(  -524.81), EASYSIMD_FLOAT32_C(  -182.17), EASYSIMD_FLOAT32_C(   649.98) },
      UINT8_C(106),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   420.31), EASYSIMD_FLOAT32_C(   726.25), EASYSIMD_FLOAT32_C(  -425.66),
        EASYSIMD_FLOAT32_C(   519.34), EASYSIMD_FLOAT32_C(   413.17), EASYSIMD_FLOAT32_C(   674.22), EASYSIMD_FLOAT32_C(  -345.82),
        EASYSIMD_FLOAT32_C(  -228.35), EASYSIMD_FLOAT32_C(   -30.31), EASYSIMD_FLOAT32_C(  -791.64), EASYSIMD_FLOAT32_C(   638.20),
        EASYSIMD_FLOAT32_C(  -289.44), EASYSIMD_FLOAT32_C(   644.82), EASYSIMD_FLOAT32_C(   954.47), EASYSIMD_FLOAT32_C(  -830.97) },
       INT32_C(          64),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(  -683.72), EASYSIMD_FLOAT32_C(   420.31), EASYSIMD_FLOAT32_C(  -593.60), EASYSIMD_FLOAT32_C(  -425.69),
        EASYSIMD_FLOAT32_C(   507.21), EASYSIMD_FLOAT32_C(   413.19), EASYSIMD_FLOAT32_C(   674.25), EASYSIMD_FLOAT32_C(   211.45),
        EASYSIMD_FLOAT32_C(   545.03), EASYSIMD_FLOAT32_C(   396.72), EASYSIMD_FLOAT32_C(   252.12), EASYSIMD_FLOAT32_C(  -162.44),
        EASYSIMD_FLOAT32_C(  -909.04), EASYSIMD_FLOAT32_C(  -524.81), EASYSIMD_FLOAT32_C(  -182.17), EASYSIMD_FLOAT32_C(   649.98) } },
    { { EASYSIMD_FLOAT32_C(   318.48), EASYSIMD_FLOAT32_C(  -112.31), EASYSIMD_FLOAT32_C(   847.99), EASYSIMD_FLOAT32_C(  -284.80),
        EASYSIMD_FLOAT32_C(  -860.19), EASYSIMD_FLOAT32_C(  -314.45), EASYSIMD_FLOAT32_C(  -193.84), EASYSIMD_FLOAT32_C(  -385.00),
        EASYSIMD_FLOAT32_C(   503.38), EASYSIMD_FLOAT32_C(  -543.86), EASYSIMD_FLOAT32_C(   367.57), EASYSIMD_FLOAT32_C(  -848.04),
        EASYSIMD_FLOAT32_C(   876.46), EASYSIMD_FLOAT32_C(    93.82), EASYSIMD_FLOAT32_C(  -273.70), EASYSIMD_FLOAT32_C(   395.80) },
      UINT8_C( 50),
      { EASYSIMD_FLOAT32_C(  -599.48),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   278.64), EASYSIMD_FLOAT32_C(   370.22),
        EASYSIMD_FLOAT32_C(  -741.66), EASYSIMD_FLOAT32_C(   -83.17), EASYSIMD_FLOAT32_C(  -919.22), EASYSIMD_FLOAT32_C(   903.16),
        EASYSIMD_FLOAT32_C(  -128.69), EASYSIMD_FLOAT32_C(  -750.19), EASYSIMD_FLOAT32_C(   954.39), EASYSIMD_FLOAT32_C(  -740.23),
        EASYSIMD_FLOAT32_C(   926.06), EASYSIMD_FLOAT32_C(  -742.65), EASYSIMD_FLOAT32_C(   578.25), EASYSIMD_FLOAT32_C(  -186.24) },
       INT32_C(         177),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   318.48),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   847.99), EASYSIMD_FLOAT32_C(  -284.80),
        EASYSIMD_FLOAT32_C(  -741.66), EASYSIMD_FLOAT32_C(   -83.17), EASYSIMD_FLOAT32_C(  -193.84), EASYSIMD_FLOAT32_C(  -385.00),
        EASYSIMD_FLOAT32_C(   503.38), EASYSIMD_FLOAT32_C(  -543.86), EASYSIMD_FLOAT32_C(   367.57), EASYSIMD_FLOAT32_C(  -848.04),
        EASYSIMD_FLOAT32_C(   876.46), EASYSIMD_FLOAT32_C(    93.82), EASYSIMD_FLOAT32_C(  -273.70), EASYSIMD_FLOAT32_C(   395.80) } },
    { { EASYSIMD_FLOAT32_C(   568.56), EASYSIMD_FLOAT32_C(  -705.73), EASYSIMD_FLOAT32_C(   555.76), EASYSIMD_FLOAT32_C(   -63.87),
        EASYSIMD_FLOAT32_C(  -553.77), EASYSIMD_FLOAT32_C(   432.21), EASYSIMD_FLOAT32_C(  -970.05), EASYSIMD_FLOAT32_C(   172.53),
        EASYSIMD_FLOAT32_C(  -171.99), EASYSIMD_FLOAT32_C(  -463.06), EASYSIMD_FLOAT32_C(   573.05), EASYSIMD_FLOAT32_C(  -122.01),
        EASYSIMD_FLOAT32_C(   815.58), EASYSIMD_FLOAT32_C(   -56.73), EASYSIMD_FLOAT32_C(   136.33), EASYSIMD_FLOAT32_C(  -267.59) },
      UINT8_C( 31),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   603.72), EASYSIMD_FLOAT32_C(   273.86), EASYSIMD_FLOAT32_C(    -6.12),
        EASYSIMD_FLOAT32_C(   863.49), EASYSIMD_FLOAT32_C(   199.92), EASYSIMD_FLOAT32_C(   251.23), EASYSIMD_FLOAT32_C(   441.74),
        EASYSIMD_FLOAT32_C(  -986.32), EASYSIMD_FLOAT32_C(   356.57), EASYSIMD_FLOAT32_C(   735.19), EASYSIMD_FLOAT32_C(   -32.75),
        EASYSIMD_FLOAT32_C(  -852.54), EASYSIMD_FLOAT32_C(  -165.20), EASYSIMD_FLOAT32_C(  -464.19), EASYSIMD_FLOAT32_C(  -558.27) },
       INT32_C(         242),
       INT32_C(           4),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   603.72), EASYSIMD_FLOAT32_C(   273.86), EASYSIMD_FLOAT32_C(    -6.12),
        EASYSIMD_FLOAT32_C(   863.49), EASYSIMD_FLOAT32_C(   432.21), EASYSIMD_FLOAT32_C(  -970.05), EASYSIMD_FLOAT32_C(   172.53),
        EASYSIMD_FLOAT32_C(  -171.99), EASYSIMD_FLOAT32_C(  -463.06), EASYSIMD_FLOAT32_C(   573.05), EASYSIMD_FLOAT32_C(  -122.01),
        EASYSIMD_FLOAT32_C(   815.58), EASYSIMD_FLOAT32_C(   -56.73), EASYSIMD_FLOAT32_C(   136.33), EASYSIMD_FLOAT32_C(  -267.59) } },
    { { EASYSIMD_FLOAT32_C(   501.88), EASYSIMD_FLOAT32_C(  -939.52), EASYSIMD_FLOAT32_C(  -349.21), EASYSIMD_FLOAT32_C(  -961.18),
        EASYSIMD_FLOAT32_C(   633.53), EASYSIMD_FLOAT32_C(   528.78), EASYSIMD_FLOAT32_C(   854.40), EASYSIMD_FLOAT32_C(  -423.20),
        EASYSIMD_FLOAT32_C(  -334.89), EASYSIMD_FLOAT32_C(  -413.19), EASYSIMD_FLOAT32_C(   600.85), EASYSIMD_FLOAT32_C(   704.60),
        EASYSIMD_FLOAT32_C(  -809.47), EASYSIMD_FLOAT32_C(  -125.29), EASYSIMD_FLOAT32_C(  -301.53), EASYSIMD_FLOAT32_C(  -945.98) },
      UINT8_C(138),
      { EASYSIMD_FLOAT32_C(   949.70), EASYSIMD_FLOAT32_C(   495.77), EASYSIMD_FLOAT32_C(  -911.69), EASYSIMD_FLOAT32_C(   306.27),
        EASYSIMD_FLOAT32_C(   230.96), EASYSIMD_FLOAT32_C(    55.56), EASYSIMD_FLOAT32_C(   453.73), EASYSIMD_FLOAT32_C(  -934.24),
        EASYSIMD_FLOAT32_C(   591.37), EASYSIMD_FLOAT32_C(   895.45), EASYSIMD_FLOAT32_C(  -543.68), EASYSIMD_FLOAT32_C(    63.30),
        EASYSIMD_FLOAT32_C(  -216.59), EASYSIMD_FLOAT32_C(  -720.90), EASYSIMD_FLOAT32_C(  -434.81), EASYSIMD_FLOAT32_C(  -156.11) },
       INT32_C(          83),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   501.88), EASYSIMD_FLOAT32_C(   495.75), EASYSIMD_FLOAT32_C(  -349.21), EASYSIMD_FLOAT32_C(   306.25),
        EASYSIMD_FLOAT32_C(   633.53), EASYSIMD_FLOAT32_C(   528.78), EASYSIMD_FLOAT32_C(   854.40), EASYSIMD_FLOAT32_C(  -934.22),
        EASYSIMD_FLOAT32_C(  -334.89), EASYSIMD_FLOAT32_C(  -413.19), EASYSIMD_FLOAT32_C(   600.85), EASYSIMD_FLOAT32_C(   704.60),
        EASYSIMD_FLOAT32_C(  -809.47), EASYSIMD_FLOAT32_C(  -125.29), EASYSIMD_FLOAT32_C(  -301.53), EASYSIMD_FLOAT32_C(  -945.98) } },
    { { EASYSIMD_FLOAT32_C(  -541.34), EASYSIMD_FLOAT32_C(  -541.59), EASYSIMD_FLOAT32_C(    54.22), EASYSIMD_FLOAT32_C(   123.77),
        EASYSIMD_FLOAT32_C(    45.22), EASYSIMD_FLOAT32_C(  -344.93), EASYSIMD_FLOAT32_C(  -171.63), EASYSIMD_FLOAT32_C(   235.75),
        EASYSIMD_FLOAT32_C(   529.78), EASYSIMD_FLOAT32_C(   526.84), EASYSIMD_FLOAT32_C(   289.78), EASYSIMD_FLOAT32_C(   604.42),
        EASYSIMD_FLOAT32_C(   476.54), EASYSIMD_FLOAT32_C(  -214.46), EASYSIMD_FLOAT32_C(   692.73), EASYSIMD_FLOAT32_C(  -217.19) },
      UINT8_C(173),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -763.46), EASYSIMD_FLOAT32_C(  -917.74), EASYSIMD_FLOAT32_C(  -660.34),
        EASYSIMD_FLOAT32_C(  -868.01), EASYSIMD_FLOAT32_C(  -461.42), EASYSIMD_FLOAT32_C(   402.96), EASYSIMD_FLOAT32_C(   -84.60),
        EASYSIMD_FLOAT32_C(  -182.32), EASYSIMD_FLOAT32_C(   968.15), EASYSIMD_FLOAT32_C(   759.29), EASYSIMD_FLOAT32_C(   747.56),
        EASYSIMD_FLOAT32_C(  -427.84), EASYSIMD_FLOAT32_C(  -763.29), EASYSIMD_FLOAT32_C(  -793.77), EASYSIMD_FLOAT32_C(    30.57) },
       INT32_C(         100),
       INT32_C(           4),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -541.59), EASYSIMD_FLOAT32_C(  -917.73), EASYSIMD_FLOAT32_C(  -660.34),
        EASYSIMD_FLOAT32_C(    45.22), EASYSIMD_FLOAT32_C(  -461.42), EASYSIMD_FLOAT32_C(  -171.63), EASYSIMD_FLOAT32_C(   -84.59),
        EASYSIMD_FLOAT32_C(   529.78), EASYSIMD_FLOAT32_C(   526.84), EASYSIMD_FLOAT32_C(   289.78), EASYSIMD_FLOAT32_C(   604.42),
        EASYSIMD_FLOAT32_C(   476.54), EASYSIMD_FLOAT32_C(  -214.46), EASYSIMD_FLOAT32_C(   692.73), EASYSIMD_FLOAT32_C(  -217.19) } },
    { { EASYSIMD_FLOAT32_C(  -841.63), EASYSIMD_FLOAT32_C(   311.54), EASYSIMD_FLOAT32_C(   475.79), EASYSIMD_FLOAT32_C(   685.21),
        EASYSIMD_FLOAT32_C(  -398.68), EASYSIMD_FLOAT32_C(    80.21), EASYSIMD_FLOAT32_C(   161.75), EASYSIMD_FLOAT32_C(   386.86),
        EASYSIMD_FLOAT32_C(  -227.06), EASYSIMD_FLOAT32_C(   944.56), EASYSIMD_FLOAT32_C(   403.36), EASYSIMD_FLOAT32_C(   521.23),
        EASYSIMD_FLOAT32_C(  -818.90), EASYSIMD_FLOAT32_C(   485.62), EASYSIMD_FLOAT32_C(   860.89), EASYSIMD_FLOAT32_C(  -686.90) },
      UINT8_C( 71),
      { EASYSIMD_FLOAT32_C(   263.85),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -158.11), EASYSIMD_FLOAT32_C(   231.99),
        EASYSIMD_FLOAT32_C(   -12.21), EASYSIMD_FLOAT32_C(  -410.55), EASYSIMD_FLOAT32_C(   804.15), EASYSIMD_FLOAT32_C(   224.51),
        EASYSIMD_FLOAT32_C(  -204.32), EASYSIMD_FLOAT32_C(  -165.28), EASYSIMD_FLOAT32_C(  -484.56), EASYSIMD_FLOAT32_C(  -874.32),
        EASYSIMD_FLOAT32_C(   -89.50), EASYSIMD_FLOAT32_C(  -538.55), EASYSIMD_FLOAT32_C(  -715.95), EASYSIMD_FLOAT32_C(  -777.95) },
       INT32_C(         240),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   263.85),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -158.11), EASYSIMD_FLOAT32_C(   685.21),
        EASYSIMD_FLOAT32_C(  -398.68), EASYSIMD_FLOAT32_C(    80.21), EASYSIMD_FLOAT32_C(   804.15), EASYSIMD_FLOAT32_C(   386.86),
        EASYSIMD_FLOAT32_C(  -227.06), EASYSIMD_FLOAT32_C(   944.56), EASYSIMD_FLOAT32_C(   403.36), EASYSIMD_FLOAT32_C(   521.23),
        EASYSIMD_FLOAT32_C(  -818.90), EASYSIMD_FLOAT32_C(   485.62), EASYSIMD_FLOAT32_C(   860.89), EASYSIMD_FLOAT32_C(  -686.90) } },
    { { EASYSIMD_FLOAT32_C(  -789.77), EASYSIMD_FLOAT32_C(   790.38), EASYSIMD_FLOAT32_C(    75.57), EASYSIMD_FLOAT32_C(   613.60),
        EASYSIMD_FLOAT32_C(   311.61), EASYSIMD_FLOAT32_C(   256.68), EASYSIMD_FLOAT32_C(    99.22), EASYSIMD_FLOAT32_C(   172.50),
        EASYSIMD_FLOAT32_C(   569.77), EASYSIMD_FLOAT32_C(   123.43), EASYSIMD_FLOAT32_C(  -563.65), EASYSIMD_FLOAT32_C(  -201.73),
        EASYSIMD_FLOAT32_C(   965.31), EASYSIMD_FLOAT32_C(   668.34), EASYSIMD_FLOAT32_C(   786.06), EASYSIMD_FLOAT32_C(  -445.24) },
      UINT8_C( 96),
      { EASYSIMD_FLOAT32_C(    10.57), EASYSIMD_FLOAT32_C(   350.44), EASYSIMD_FLOAT32_C(  -692.79), EASYSIMD_FLOAT32_C(   526.01),
        EASYSIMD_FLOAT32_C(   476.12), EASYSIMD_FLOAT32_C(   217.72), EASYSIMD_FLOAT32_C(   987.46), EASYSIMD_FLOAT32_C(   760.17),
        EASYSIMD_FLOAT32_C(   439.76), EASYSIMD_FLOAT32_C(   924.70), EASYSIMD_FLOAT32_C(   729.42), EASYSIMD_FLOAT32_C(  -736.87),
        EASYSIMD_FLOAT32_C(   -57.85), EASYSIMD_FLOAT32_C(  -139.57), EASYSIMD_FLOAT32_C(  -526.64), EASYSIMD_FLOAT32_C(  -267.47) },
       INT32_C(          33),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -789.77), EASYSIMD_FLOAT32_C(   790.38), EASYSIMD_FLOAT32_C(    75.57), EASYSIMD_FLOAT32_C(   613.60),
        EASYSIMD_FLOAT32_C(   311.61), EASYSIMD_FLOAT32_C(   217.50), EASYSIMD_FLOAT32_C(   987.25), EASYSIMD_FLOAT32_C(   172.50),
        EASYSIMD_FLOAT32_C(   569.77), EASYSIMD_FLOAT32_C(   123.43), EASYSIMD_FLOAT32_C(  -563.65), EASYSIMD_FLOAT32_C(  -201.73),
        EASYSIMD_FLOAT32_C(   965.31), EASYSIMD_FLOAT32_C(   668.34), EASYSIMD_FLOAT32_C(   786.06), EASYSIMD_FLOAT32_C(  -445.24) } },
    { { EASYSIMD_FLOAT32_C(   192.68), EASYSIMD_FLOAT32_C(   186.18), EASYSIMD_FLOAT32_C(   216.65), EASYSIMD_FLOAT32_C(  -237.55),
        EASYSIMD_FLOAT32_C(  -690.39), EASYSIMD_FLOAT32_C(   653.00), EASYSIMD_FLOAT32_C(   560.73), EASYSIMD_FLOAT32_C(  -725.08),
        EASYSIMD_FLOAT32_C(   321.34), EASYSIMD_FLOAT32_C(   346.79), EASYSIMD_FLOAT32_C(  -170.31), EASYSIMD_FLOAT32_C(  -206.17),
        EASYSIMD_FLOAT32_C(  -642.64), EASYSIMD_FLOAT32_C(  -819.87), EASYSIMD_FLOAT32_C(   101.05), EASYSIMD_FLOAT32_C(   883.37) },
      UINT8_C(188),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   870.84), EASYSIMD_FLOAT32_C(   416.42), EASYSIMD_FLOAT32_C(   758.53),
        EASYSIMD_FLOAT32_C(   795.54), EASYSIMD_FLOAT32_C(   145.85), EASYSIMD_FLOAT32_C(  -978.34), EASYSIMD_FLOAT32_C(  -262.31),
        EASYSIMD_FLOAT32_C(  -993.72), EASYSIMD_FLOAT32_C(  -504.98), EASYSIMD_FLOAT32_C(   470.22), EASYSIMD_FLOAT32_C(   942.28),
        EASYSIMD_FLOAT32_C(  -418.02), EASYSIMD_FLOAT32_C(   514.37), EASYSIMD_FLOAT32_C(   134.96), EASYSIMD_FLOAT32_C(   768.16) },
       INT32_C(          66),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(   192.68), EASYSIMD_FLOAT32_C(   186.18), EASYSIMD_FLOAT32_C(   416.44), EASYSIMD_FLOAT32_C(   758.56),
        EASYSIMD_FLOAT32_C(   795.56), EASYSIMD_FLOAT32_C(   145.88), EASYSIMD_FLOAT32_C(   560.73), EASYSIMD_FLOAT32_C(  -262.25),
        EASYSIMD_FLOAT32_C(   321.34), EASYSIMD_FLOAT32_C(   346.79), EASYSIMD_FLOAT32_C(  -170.31), EASYSIMD_FLOAT32_C(  -206.17),
        EASYSIMD_FLOAT32_C(  -642.64), EASYSIMD_FLOAT32_C(  -819.87), EASYSIMD_FLOAT32_C(   101.05), EASYSIMD_FLOAT32_C(   883.37) } },
  };

  easysimd__m512 src, a, r;

  src = easysimd_mm512_loadu_ps(test_vec[0].src);
  a = easysimd_mm512_loadu_ps(test_vec[0].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[0].k, a, INT32_C(          64), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[0].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[1].src);
  a = easysimd_mm512_loadu_ps(test_vec[1].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[1].k, a, INT32_C(         177), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[1].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[2].src);
  a = easysimd_mm512_loadu_ps(test_vec[2].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[2].k, a, INT32_C(         242), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[2].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[3].src);
  a = easysimd_mm512_loadu_ps(test_vec[3].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[3].k, a, INT32_C(          83), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[3].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[4].src);
  a = easysimd_mm512_loadu_ps(test_vec[4].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[4].k, a, INT32_C(         100), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[4].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[5].src);
  a = easysimd_mm512_loadu_ps(test_vec[5].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[5].k, a, INT32_C(         240), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[5].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[6].src);
  a = easysimd_mm512_loadu_ps(test_vec[6].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[6].k, a, INT32_C(          33), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[6].r), 1);

  src = easysimd_mm512_loadu_ps(test_vec[7].src);
  a = easysimd_mm512_loadu_ps(test_vec[7].a);
  r = easysimd_mm512_mask_roundscale_round_ps(src, test_vec[7].k, a, INT32_C(          66), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512 src = easysimd_test_x86_random_f32x16(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m512 a = easysimd_test_x86_random_f32x16(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        a = easysimd_mm512_mask_mov_ps(a, 1, easysimd_mm512_set1_ps(EASYSIMD_MATH_NANF));
      else {
        if((easysimd_test_codegen_rand() & 1))
          a = easysimd_mm512_mask_mov_ps(a, 2, easysimd_mm512_set1_ps(EASYSIMD_MATH_INFINITY));
        else
          a = easysimd_mm512_mask_mov_ps(a, 2, easysimd_mm512_set1_ps(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION: EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m512 r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm512_mask_roundscale_round_ps, r, easysimd_mm512_setzero_ps(), imm8, sae, src, k, a);

    easysimd_test_x86_write_f32x16(2, src, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x16(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x16(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_maskz_roundscale_round_ps (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd__mmask8 k;
    const easysimd_float32 a[16];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float32 r[16];
  } test_vec[] = {
    { UINT8_C(117),
      { EASYSIMD_FLOAT32_C(  -647.31),     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -195.07), EASYSIMD_FLOAT32_C(   182.38),
        EASYSIMD_FLOAT32_C(  -500.81), EASYSIMD_FLOAT32_C(   162.29), EASYSIMD_FLOAT32_C(   362.51), EASYSIMD_FLOAT32_C(   600.24),
        EASYSIMD_FLOAT32_C(    45.66), EASYSIMD_FLOAT32_C(    18.76), EASYSIMD_FLOAT32_C(   919.00), EASYSIMD_FLOAT32_C(   -83.51),
        EASYSIMD_FLOAT32_C(  -564.82), EASYSIMD_FLOAT32_C(   677.53), EASYSIMD_FLOAT32_C(  -287.97), EASYSIMD_FLOAT32_C(   581.03) },
       INT32_C(         192),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(  -647.31), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -195.07), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(  -500.81), EASYSIMD_FLOAT32_C(   162.29), EASYSIMD_FLOAT32_C(   362.51), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C( 15),
      { EASYSIMD_FLOAT32_C(  -223.80), EASYSIMD_FLOAT32_C(  -565.68), EASYSIMD_FLOAT32_C(  -335.46), EASYSIMD_FLOAT32_C(  -455.64),
        EASYSIMD_FLOAT32_C(   165.34), EASYSIMD_FLOAT32_C(  -438.04), EASYSIMD_FLOAT32_C(  -377.87), EASYSIMD_FLOAT32_C(   549.36),
        EASYSIMD_FLOAT32_C(  -979.91), EASYSIMD_FLOAT32_C(   -25.17), EASYSIMD_FLOAT32_C(   254.71), EASYSIMD_FLOAT32_C(  -174.98),
        EASYSIMD_FLOAT32_C(  -842.79), EASYSIMD_FLOAT32_C(   753.91), EASYSIMD_FLOAT32_C(   987.31), EASYSIMD_FLOAT32_C(   519.72) },
       INT32_C(          65),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(  -223.81), EASYSIMD_FLOAT32_C(  -565.69), EASYSIMD_FLOAT32_C(  -335.50), EASYSIMD_FLOAT32_C(  -455.69),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C( 49),
      { EASYSIMD_FLOAT32_C(   949.46), EASYSIMD_FLOAT32_C(   -26.34), EASYSIMD_FLOAT32_C(   -49.32), EASYSIMD_FLOAT32_C(  -338.51),
        EASYSIMD_FLOAT32_C(  -445.32), EASYSIMD_FLOAT32_C(  -350.13), EASYSIMD_FLOAT32_C(  -888.78), EASYSIMD_FLOAT32_C(  -858.02),
        EASYSIMD_FLOAT32_C(  -155.91), EASYSIMD_FLOAT32_C(    31.16), EASYSIMD_FLOAT32_C(   671.57), EASYSIMD_FLOAT32_C(   620.29),
        EASYSIMD_FLOAT32_C(   465.48), EASYSIMD_FLOAT32_C(  -663.89), EASYSIMD_FLOAT32_C(  -835.35), EASYSIMD_FLOAT32_C(  -369.18) },
       INT32_C(         226),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   949.46), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(  -445.32), EASYSIMD_FLOAT32_C(  -350.13), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C(121),
      { EASYSIMD_FLOAT32_C(   761.61), EASYSIMD_FLOAT32_C(   434.89), EASYSIMD_FLOAT32_C(   743.18), EASYSIMD_FLOAT32_C(   918.82),
        EASYSIMD_FLOAT32_C(   188.79), EASYSIMD_FLOAT32_C(   730.49), EASYSIMD_FLOAT32_C(   438.54), EASYSIMD_FLOAT32_C(  -457.06),
        EASYSIMD_FLOAT32_C(  -236.54), EASYSIMD_FLOAT32_C(   977.01), EASYSIMD_FLOAT32_C(   816.09), EASYSIMD_FLOAT32_C(  -287.08),
        EASYSIMD_FLOAT32_C(   -49.33), EASYSIMD_FLOAT32_C(  -233.23), EASYSIMD_FLOAT32_C(   374.41), EASYSIMD_FLOAT32_C(   505.35) },
       INT32_C(         147),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(   761.61), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(   918.82),
        EASYSIMD_FLOAT32_C(   188.79), EASYSIMD_FLOAT32_C(   730.49), EASYSIMD_FLOAT32_C(   438.54), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C( 82),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   318.90), EASYSIMD_FLOAT32_C(   881.02), EASYSIMD_FLOAT32_C(   982.27),
        EASYSIMD_FLOAT32_C(   655.01), EASYSIMD_FLOAT32_C(  -954.33), EASYSIMD_FLOAT32_C(  -386.91), EASYSIMD_FLOAT32_C(  -446.92),
        EASYSIMD_FLOAT32_C(  -167.55), EASYSIMD_FLOAT32_C(  -206.74), EASYSIMD_FLOAT32_C(   471.24), EASYSIMD_FLOAT32_C(  -405.94),
        EASYSIMD_FLOAT32_C(  -771.85), EASYSIMD_FLOAT32_C(   214.42), EASYSIMD_FLOAT32_C(  -487.12), EASYSIMD_FLOAT32_C(   416.95) },
       INT32_C(         180),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(   318.90), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(   655.01), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -386.91), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C(134),
      { EASYSIMD_FLOAT32_C(   775.97), EASYSIMD_FLOAT32_C(  -578.72), EASYSIMD_FLOAT32_C(  -120.90), EASYSIMD_FLOAT32_C(  -457.26),
        EASYSIMD_FLOAT32_C(   795.69), EASYSIMD_FLOAT32_C(  -615.55), EASYSIMD_FLOAT32_C(   959.38), EASYSIMD_FLOAT32_C(   281.32),
        EASYSIMD_FLOAT32_C(  -968.22), EASYSIMD_FLOAT32_C(  -779.89), EASYSIMD_FLOAT32_C(   798.10), EASYSIMD_FLOAT32_C(   350.68),
        EASYSIMD_FLOAT32_C(  -898.87), EASYSIMD_FLOAT32_C(   780.37), EASYSIMD_FLOAT32_C(     5.70), EASYSIMD_FLOAT32_C(  -853.21) },
       INT32_C(         128),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -578.72), EASYSIMD_FLOAT32_C(  -120.90), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(   281.32),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C(160),
      { EASYSIMD_FLOAT32_C(    30.02), EASYSIMD_FLOAT32_C(   573.31), EASYSIMD_FLOAT32_C(   414.88), EASYSIMD_FLOAT32_C(  -755.56),
        EASYSIMD_FLOAT32_C(  -913.81), EASYSIMD_FLOAT32_C(  -168.18), EASYSIMD_FLOAT32_C(   189.35), EASYSIMD_FLOAT32_C(  -962.39),
        EASYSIMD_FLOAT32_C(  -208.29), EASYSIMD_FLOAT32_C(  -102.29), EASYSIMD_FLOAT32_C(   966.04), EASYSIMD_FLOAT32_C(  -432.32),
        EASYSIMD_FLOAT32_C(   318.99), EASYSIMD_FLOAT32_C(  -154.87), EASYSIMD_FLOAT32_C(   110.42), EASYSIMD_FLOAT32_C(   114.68) },
       INT32_C(          65),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -168.19), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -962.44),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
    { UINT8_C(113),
      { EASYSIMD_FLOAT32_C(   289.91),      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -387.95), EASYSIMD_FLOAT32_C(   391.04),
        EASYSIMD_FLOAT32_C(   974.47), EASYSIMD_FLOAT32_C(   617.75), EASYSIMD_FLOAT32_C(   537.83), EASYSIMD_FLOAT32_C(  -632.07),
        EASYSIMD_FLOAT32_C(   176.52), EASYSIMD_FLOAT32_C(  -482.92), EASYSIMD_FLOAT32_C(   554.66), EASYSIMD_FLOAT32_C(  -793.46),
        EASYSIMD_FLOAT32_C(  -909.62), EASYSIMD_FLOAT32_C(   -30.47), EASYSIMD_FLOAT32_C(  -549.02), EASYSIMD_FLOAT32_C(  -823.43) },
       INT32_C(         130),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   289.91), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(   974.47), EASYSIMD_FLOAT32_C(   617.75), EASYSIMD_FLOAT32_C(   537.83), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00),
        EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(     0.00) } },
  };

  easysimd__m512 a, r;

  a = easysimd_mm512_loadu_ps(test_vec[0].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[0].k, a, INT32_C(         192), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[0].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[1].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[1].k, a, INT32_C(          65), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[1].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[2].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[2].k, a, INT32_C(         226), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[2].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[3].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[3].k, a, INT32_C(         147), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[3].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[4].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[4].k, a, INT32_C(         180), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[4].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[5].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[5].k, a, INT32_C(         128), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[5].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[6].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[6].k, a, INT32_C(          65), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[6].r), 1);

  a = easysimd_mm512_loadu_ps(test_vec[7].a);
  r = easysimd_mm512_maskz_roundscale_round_ps(test_vec[7].k, a, INT32_C(         130), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x16(r, easysimd_mm512_loadu_ps(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m512 a = easysimd_test_x86_random_f32x16(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        a = easysimd_mm512_mask_mov_ps(a, 1, easysimd_mm512_set1_ps(EASYSIMD_MATH_NANF));
      else {
        if((easysimd_test_codegen_rand() & 1))
          a = easysimd_mm512_mask_mov_ps(a, 2, easysimd_mm512_set1_ps(EASYSIMD_MATH_INFINITY));
        else
          a = easysimd_mm512_mask_mov_ps(a, 2, easysimd_mm512_set1_ps(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION: EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m512 r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm512_maskz_roundscale_round_ps, r, easysimd_mm512_setzero_ps(), imm8, sae, k, a);

    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_f32x16(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x16(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_roundscale_round_pd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float64 a[8];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float64 r[8];
  } test_vec[] = {
    { { EASYSIMD_FLOAT64_C(  -764.76), EASYSIMD_FLOAT64_C(   372.30), EASYSIMD_FLOAT64_C(  -204.93), EASYSIMD_FLOAT64_C(   187.19),
        EASYSIMD_FLOAT64_C(   319.82), EASYSIMD_FLOAT64_C(  -587.65), EASYSIMD_FLOAT64_C(  -285.97), EASYSIMD_FLOAT64_C(  -184.26) },
       INT32_C(         224),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -764.76), EASYSIMD_FLOAT64_C(   372.30), EASYSIMD_FLOAT64_C(  -204.93), EASYSIMD_FLOAT64_C(   187.19),
        EASYSIMD_FLOAT64_C(   319.82), EASYSIMD_FLOAT64_C(  -587.65), EASYSIMD_FLOAT64_C(  -285.97), EASYSIMD_FLOAT64_C(  -184.26) } },
    { {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -737.42), EASYSIMD_FLOAT64_C(   189.61), EASYSIMD_FLOAT64_C(   596.45),
        EASYSIMD_FLOAT64_C(  -867.46), EASYSIMD_FLOAT64_C(  -762.70), EASYSIMD_FLOAT64_C(    52.01), EASYSIMD_FLOAT64_C(   506.49) },
       INT32_C(         225),
       INT32_C(           8),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -737.42), EASYSIMD_FLOAT64_C(   189.61), EASYSIMD_FLOAT64_C(   596.45),
        EASYSIMD_FLOAT64_C(  -867.46), EASYSIMD_FLOAT64_C(  -762.70), EASYSIMD_FLOAT64_C(    52.01), EASYSIMD_FLOAT64_C(   506.49) } },
    { { EASYSIMD_FLOAT64_C(  -225.83), EASYSIMD_FLOAT64_C(   341.08), EASYSIMD_FLOAT64_C(  -924.52), EASYSIMD_FLOAT64_C(   659.69),
        EASYSIMD_FLOAT64_C(   637.52), EASYSIMD_FLOAT64_C(   570.34), EASYSIMD_FLOAT64_C(  -794.05), EASYSIMD_FLOAT64_C(   295.70) },
       INT32_C(         114),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(  -225.83), EASYSIMD_FLOAT64_C(   341.09), EASYSIMD_FLOAT64_C(  -924.52), EASYSIMD_FLOAT64_C(   659.70),
        EASYSIMD_FLOAT64_C(   637.52), EASYSIMD_FLOAT64_C(   570.34), EASYSIMD_FLOAT64_C(  -794.05), EASYSIMD_FLOAT64_C(   295.70) } },
    { { EASYSIMD_FLOAT64_C(    -7.23), EASYSIMD_FLOAT64_C(  -101.93), EASYSIMD_FLOAT64_C(  -496.88), EASYSIMD_FLOAT64_C(   706.80),
        EASYSIMD_FLOAT64_C(   713.81), EASYSIMD_FLOAT64_C(    25.71), EASYSIMD_FLOAT64_C(  -458.99), EASYSIMD_FLOAT64_C(  -420.32) },
       INT32_C(          35),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(    -7.00), EASYSIMD_FLOAT64_C(  -101.75), EASYSIMD_FLOAT64_C(  -496.75), EASYSIMD_FLOAT64_C(   706.75),
        EASYSIMD_FLOAT64_C(   713.75), EASYSIMD_FLOAT64_C(    25.50), EASYSIMD_FLOAT64_C(  -458.75), EASYSIMD_FLOAT64_C(  -420.25) } },
    { {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   -63.86), EASYSIMD_FLOAT64_C(  -993.41), EASYSIMD_FLOAT64_C(   848.39),
        EASYSIMD_FLOAT64_C(  -557.37), EASYSIMD_FLOAT64_C(  -180.81), EASYSIMD_FLOAT64_C(  -935.49), EASYSIMD_FLOAT64_C(   801.51) },
       INT32_C(         100),
       INT32_C(           4),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   -63.86), EASYSIMD_FLOAT64_C(  -993.41), EASYSIMD_FLOAT64_C(   848.39),
        EASYSIMD_FLOAT64_C(  -557.38), EASYSIMD_FLOAT64_C(  -180.81), EASYSIMD_FLOAT64_C(  -935.48), EASYSIMD_FLOAT64_C(   801.52) } },
    { { EASYSIMD_FLOAT64_C(  -501.64), EASYSIMD_FLOAT64_C(  -219.90), EASYSIMD_FLOAT64_C(  -472.78), EASYSIMD_FLOAT64_C(  -295.68),
        EASYSIMD_FLOAT64_C(  -924.20), EASYSIMD_FLOAT64_C(  -667.20), EASYSIMD_FLOAT64_C(  -717.43), EASYSIMD_FLOAT64_C(  -833.43) },
       INT32_C(          48),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -501.62), EASYSIMD_FLOAT64_C(  -219.88), EASYSIMD_FLOAT64_C(  -472.75), EASYSIMD_FLOAT64_C(  -295.62),
        EASYSIMD_FLOAT64_C(  -924.25), EASYSIMD_FLOAT64_C(  -667.25), EASYSIMD_FLOAT64_C(  -717.38), EASYSIMD_FLOAT64_C(  -833.38) } },
    { { EASYSIMD_FLOAT64_C(    32.37),       -EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   695.40), EASYSIMD_FLOAT64_C(   573.38),
        EASYSIMD_FLOAT64_C(   474.12), EASYSIMD_FLOAT64_C(  -104.66), EASYSIMD_FLOAT64_C(  -623.03), EASYSIMD_FLOAT64_C(   243.41) },
       INT32_C(          33),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(    32.25),       -EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   695.25), EASYSIMD_FLOAT64_C(   573.25),
        EASYSIMD_FLOAT64_C(   474.00), EASYSIMD_FLOAT64_C(  -104.75), EASYSIMD_FLOAT64_C(  -623.25), EASYSIMD_FLOAT64_C(   243.25) } },
    { { EASYSIMD_FLOAT64_C(  -930.80),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   557.24), EASYSIMD_FLOAT64_C(   -49.40),
        EASYSIMD_FLOAT64_C(  -556.69), EASYSIMD_FLOAT64_C(  -300.17), EASYSIMD_FLOAT64_C(   907.48), EASYSIMD_FLOAT64_C(   -58.33) },
       INT32_C(         210),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -930.80),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   557.24), EASYSIMD_FLOAT64_C(   -49.40),
        EASYSIMD_FLOAT64_C(  -556.69), EASYSIMD_FLOAT64_C(  -300.17), EASYSIMD_FLOAT64_C(   907.48), EASYSIMD_FLOAT64_C(   -58.33) } },
  };

  easysimd__m512d a, r;

  a = easysimd_mm512_loadu_pd(test_vec[0].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(         224), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[0].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[1].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(         225), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[1].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[2].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(         114), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[2].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[3].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(          35), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[3].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[4].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(         100), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[4].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[5].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(          48), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[5].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[6].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(          33), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[6].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[7].a);
  r = easysimd_mm512_roundscale_round_pd(a, INT32_C(         210), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512d a = easysimd_test_x86_random_f64x8(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        a = easysimd_mm512_mask_mov_pd(a, 1, easysimd_mm512_set1_pd(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          a = easysimd_mm512_mask_mov_pd(a, 2, easysimd_mm512_set1_pd(EASYSIMD_MATH_INFINITY));
        else
          a = easysimd_mm512_mask_mov_pd(a, 2, easysimd_mm512_set1_pd(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION : EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m512d r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm512_roundscale_round_pd, r, easysimd_mm512_setzero_pd(), imm8, sae, a);

    easysimd_test_x86_write_f64x8(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x8(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_mask_roundscale_round_pd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float64 src[8];
    const easysimd__mmask8 k;
    const easysimd_float64 a[8];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float64 r[8];
  } test_vec[] = {
    { { EASYSIMD_FLOAT64_C(   586.90), EASYSIMD_FLOAT64_C(  -112.94), EASYSIMD_FLOAT64_C(  -235.54), EASYSIMD_FLOAT64_C(   172.88),
        EASYSIMD_FLOAT64_C(  -277.74), EASYSIMD_FLOAT64_C(   581.03), EASYSIMD_FLOAT64_C(   348.44), EASYSIMD_FLOAT64_C(   605.57) },
      UINT8_C( 95),
      { EASYSIMD_FLOAT64_C(   311.24),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   137.73), EASYSIMD_FLOAT64_C(   690.30),
        EASYSIMD_FLOAT64_C(  -788.97), EASYSIMD_FLOAT64_C(   105.19), EASYSIMD_FLOAT64_C(   565.43), EASYSIMD_FLOAT64_C(   516.54) },
       INT32_C(          16),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(   311.00),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   137.50), EASYSIMD_FLOAT64_C(   690.50),
        EASYSIMD_FLOAT64_C(  -789.00), EASYSIMD_FLOAT64_C(   581.03), EASYSIMD_FLOAT64_C(   565.50), EASYSIMD_FLOAT64_C(   605.57) } },
    { { EASYSIMD_FLOAT64_C(  -756.52), EASYSIMD_FLOAT64_C(   407.18), EASYSIMD_FLOAT64_C(  -238.43), EASYSIMD_FLOAT64_C(   978.50),
        EASYSIMD_FLOAT64_C(   941.71), EASYSIMD_FLOAT64_C(   783.86), EASYSIMD_FLOAT64_C(  -197.05), EASYSIMD_FLOAT64_C(  -143.50) },
      UINT8_C(229),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   743.56), EASYSIMD_FLOAT64_C(   166.90), EASYSIMD_FLOAT64_C(   562.73),
        EASYSIMD_FLOAT64_C(  -534.18), EASYSIMD_FLOAT64_C(  -252.07), EASYSIMD_FLOAT64_C(   -88.83), EASYSIMD_FLOAT64_C(  -928.61) },
       INT32_C(         241),
       INT32_C(           8),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   407.18), EASYSIMD_FLOAT64_C(   166.90), EASYSIMD_FLOAT64_C(   978.50),
        EASYSIMD_FLOAT64_C(   941.71), EASYSIMD_FLOAT64_C(  -252.07), EASYSIMD_FLOAT64_C(   -88.83), EASYSIMD_FLOAT64_C(  -928.61) } },
    { { EASYSIMD_FLOAT64_C(   912.72), EASYSIMD_FLOAT64_C(  -558.33), EASYSIMD_FLOAT64_C(  -448.66), EASYSIMD_FLOAT64_C(   478.15),
        EASYSIMD_FLOAT64_C(   958.21), EASYSIMD_FLOAT64_C(  -141.38), EASYSIMD_FLOAT64_C(  -216.49), EASYSIMD_FLOAT64_C(  -842.28) },
      UINT8_C( 29),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -598.80), EASYSIMD_FLOAT64_C(  -646.62), EASYSIMD_FLOAT64_C(  -242.27),
        EASYSIMD_FLOAT64_C(  -620.30), EASYSIMD_FLOAT64_C(  -704.91), EASYSIMD_FLOAT64_C(  -458.40), EASYSIMD_FLOAT64_C(   182.65) },
       INT32_C(           2),
       INT32_C(           4),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -558.33), EASYSIMD_FLOAT64_C(  -646.00), EASYSIMD_FLOAT64_C(  -242.00),
        EASYSIMD_FLOAT64_C(  -620.00), EASYSIMD_FLOAT64_C(  -141.38), EASYSIMD_FLOAT64_C(  -216.49), EASYSIMD_FLOAT64_C(  -842.28) } },
    { { EASYSIMD_FLOAT64_C(  -889.06), EASYSIMD_FLOAT64_C(   135.23), EASYSIMD_FLOAT64_C(   360.97), EASYSIMD_FLOAT64_C(  -141.13),
        EASYSIMD_FLOAT64_C(  -953.60), EASYSIMD_FLOAT64_C(   432.35), EASYSIMD_FLOAT64_C(   167.30), EASYSIMD_FLOAT64_C(  -731.19) },
      UINT8_C(219),
      { EASYSIMD_FLOAT64_C(  -386.55), EASYSIMD_FLOAT64_C(  -818.48), EASYSIMD_FLOAT64_C(  -895.33), EASYSIMD_FLOAT64_C(   164.80),
        EASYSIMD_FLOAT64_C(   659.67), EASYSIMD_FLOAT64_C(  -937.13), EASYSIMD_FLOAT64_C(  -976.58), EASYSIMD_FLOAT64_C(  -556.82) },
       INT32_C(         163),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -386.55), EASYSIMD_FLOAT64_C(  -818.48), EASYSIMD_FLOAT64_C(   360.97), EASYSIMD_FLOAT64_C(   164.80),
        EASYSIMD_FLOAT64_C(   659.67), EASYSIMD_FLOAT64_C(   432.35), EASYSIMD_FLOAT64_C(  -976.58), EASYSIMD_FLOAT64_C(  -556.82) } },
    { { EASYSIMD_FLOAT64_C(  -378.20), EASYSIMD_FLOAT64_C(   322.99), EASYSIMD_FLOAT64_C(   197.08), EASYSIMD_FLOAT64_C(     1.49),
        EASYSIMD_FLOAT64_C(   618.08), EASYSIMD_FLOAT64_C(   738.68), EASYSIMD_FLOAT64_C(  -815.86), EASYSIMD_FLOAT64_C(  -230.34) },
      UINT8_C(148),
      { EASYSIMD_FLOAT64_C(   756.64), EASYSIMD_FLOAT64_C(   664.81), EASYSIMD_FLOAT64_C(  -206.35), EASYSIMD_FLOAT64_C(  -108.13),
        EASYSIMD_FLOAT64_C(    25.78), EASYSIMD_FLOAT64_C(   652.52), EASYSIMD_FLOAT64_C(   -61.74), EASYSIMD_FLOAT64_C(  -541.86) },
       INT32_C(         132),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -378.20), EASYSIMD_FLOAT64_C(   322.99), EASYSIMD_FLOAT64_C(  -206.35), EASYSIMD_FLOAT64_C(     1.49),
        EASYSIMD_FLOAT64_C(    25.78), EASYSIMD_FLOAT64_C(   738.68), EASYSIMD_FLOAT64_C(  -815.86), EASYSIMD_FLOAT64_C(  -541.86) } },
    { { EASYSIMD_FLOAT64_C(   433.27), EASYSIMD_FLOAT64_C(   388.59), EASYSIMD_FLOAT64_C(  -774.20), EASYSIMD_FLOAT64_C(  -401.93),
        EASYSIMD_FLOAT64_C(    48.26), EASYSIMD_FLOAT64_C(  -711.33), EASYSIMD_FLOAT64_C(  -378.51), EASYSIMD_FLOAT64_C(   491.44) },
      UINT8_C(198),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   930.79), EASYSIMD_FLOAT64_C(   131.07), EASYSIMD_FLOAT64_C(   -85.91),
        EASYSIMD_FLOAT64_C(   127.87), EASYSIMD_FLOAT64_C(  -867.44), EASYSIMD_FLOAT64_C(  -467.84), EASYSIMD_FLOAT64_C(  -133.46) },
       INT32_C(         160),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(   433.27), EASYSIMD_FLOAT64_C(   930.79), EASYSIMD_FLOAT64_C(   131.07), EASYSIMD_FLOAT64_C(  -401.93),
        EASYSIMD_FLOAT64_C(    48.26), EASYSIMD_FLOAT64_C(  -711.33), EASYSIMD_FLOAT64_C(  -467.84), EASYSIMD_FLOAT64_C(  -133.46) } },
    { { EASYSIMD_FLOAT64_C(   -33.36), EASYSIMD_FLOAT64_C(  -657.09), EASYSIMD_FLOAT64_C(   -34.78), EASYSIMD_FLOAT64_C(   992.42),
        EASYSIMD_FLOAT64_C(   995.43), EASYSIMD_FLOAT64_C(   903.48), EASYSIMD_FLOAT64_C(  -549.44), EASYSIMD_FLOAT64_C(  -184.75) },
      UINT8_C( 83),
      { EASYSIMD_FLOAT64_C(  -428.31), EASYSIMD_FLOAT64_C(  -751.48), EASYSIMD_FLOAT64_C(  -500.86), EASYSIMD_FLOAT64_C(  -202.51),
        EASYSIMD_FLOAT64_C(  -153.40), EASYSIMD_FLOAT64_C(   547.40), EASYSIMD_FLOAT64_C(    86.17), EASYSIMD_FLOAT64_C(   468.08) },
       INT32_C(          81),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -428.31), EASYSIMD_FLOAT64_C(  -751.50), EASYSIMD_FLOAT64_C(   -34.78), EASYSIMD_FLOAT64_C(   992.42),
        EASYSIMD_FLOAT64_C(  -153.41), EASYSIMD_FLOAT64_C(   903.48), EASYSIMD_FLOAT64_C(    86.16), EASYSIMD_FLOAT64_C(  -184.75) } },
    { { EASYSIMD_FLOAT64_C(   -30.38), EASYSIMD_FLOAT64_C(  -273.50), EASYSIMD_FLOAT64_C(   973.26), EASYSIMD_FLOAT64_C(  -902.51),
        EASYSIMD_FLOAT64_C(  -140.94), EASYSIMD_FLOAT64_C(  -494.57), EASYSIMD_FLOAT64_C(   -35.97), EASYSIMD_FLOAT64_C(   175.77) },
      UINT8_C(161),
      { EASYSIMD_FLOAT64_C(  -486.71), EASYSIMD_FLOAT64_C(   249.12), EASYSIMD_FLOAT64_C(  -226.11), EASYSIMD_FLOAT64_C(  -143.80),
        EASYSIMD_FLOAT64_C(  -785.67), EASYSIMD_FLOAT64_C(  -233.68), EASYSIMD_FLOAT64_C(  -148.38), EASYSIMD_FLOAT64_C(  -882.19) },
       INT32_C(         210),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(  -486.71), EASYSIMD_FLOAT64_C(  -273.50), EASYSIMD_FLOAT64_C(   973.26), EASYSIMD_FLOAT64_C(  -902.51),
        EASYSIMD_FLOAT64_C(  -140.94), EASYSIMD_FLOAT64_C(  -233.68), EASYSIMD_FLOAT64_C(   -35.97), EASYSIMD_FLOAT64_C(  -882.19) } },
  };

  easysimd__m512d src, a, r;

  src = easysimd_mm512_loadu_pd(test_vec[0].src);
  a = easysimd_mm512_loadu_pd(test_vec[0].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[0].k, a, INT32_C(          16), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[0].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[1].src);
  a = easysimd_mm512_loadu_pd(test_vec[1].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[1].k, a, INT32_C(         241), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[1].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[2].src);
  a = easysimd_mm512_loadu_pd(test_vec[2].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[2].k, a, INT32_C(           2), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[2].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[3].src);
  a = easysimd_mm512_loadu_pd(test_vec[3].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[3].k, a, INT32_C(         163), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[3].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[4].src);
  a = easysimd_mm512_loadu_pd(test_vec[4].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[4].k, a, INT32_C(         132), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[4].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[5].src);
  a = easysimd_mm512_loadu_pd(test_vec[5].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[5].k, a, INT32_C(         160), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[5].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[6].src);
  a = easysimd_mm512_loadu_pd(test_vec[6].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[6].k, a, INT32_C(          81), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[6].r), 1);

  src = easysimd_mm512_loadu_pd(test_vec[7].src);
  a = easysimd_mm512_loadu_pd(test_vec[7].a);
  r = easysimd_mm512_mask_roundscale_round_pd(src, test_vec[7].k, a, INT32_C(         210), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512d src = easysimd_test_x86_random_f64x8(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m512d a = easysimd_test_x86_random_f64x8(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        a = easysimd_mm512_mask_mov_pd(a, 1, easysimd_mm512_set1_pd(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          a = easysimd_mm512_mask_mov_pd(a, 2, easysimd_mm512_set1_pd(EASYSIMD_MATH_INFINITY));
        else
          a = easysimd_mm512_mask_mov_pd(a, 2, easysimd_mm512_set1_pd(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION : EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m512d r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm512_mask_roundscale_round_pd, r, easysimd_mm512_setzero_pd(), imm8, sae, src, k, a);

    easysimd_test_x86_write_f64x8(2, src, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x8(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x8(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_maskz_roundscale_round_pd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd__mmask8 k;
    const easysimd_float64 a[8];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float64 r[8];
  } test_vec[] = {
    { UINT8_C(190),
      { EASYSIMD_FLOAT64_C(   515.32), EASYSIMD_FLOAT64_C(    92.71), EASYSIMD_FLOAT64_C(   -98.65), EASYSIMD_FLOAT64_C(  -709.07),
        EASYSIMD_FLOAT64_C(   445.35), EASYSIMD_FLOAT64_C(  -129.46), EASYSIMD_FLOAT64_C(   180.22), EASYSIMD_FLOAT64_C(   747.49) },
       INT32_C(         176),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(    92.71), EASYSIMD_FLOAT64_C(   -98.65), EASYSIMD_FLOAT64_C(  -709.07),
        EASYSIMD_FLOAT64_C(   445.35), EASYSIMD_FLOAT64_C(  -129.46), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   747.49) } },
    { UINT8_C(118),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -392.58), EASYSIMD_FLOAT64_C(  -387.10), EASYSIMD_FLOAT64_C(    99.02),
        EASYSIMD_FLOAT64_C(   596.83), EASYSIMD_FLOAT64_C(  -871.46), EASYSIMD_FLOAT64_C(  -220.73), EASYSIMD_FLOAT64_C(   401.93) },
       INT32_C(         193),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -392.58), EASYSIMD_FLOAT64_C(  -387.10), EASYSIMD_FLOAT64_C(     0.00),
        EASYSIMD_FLOAT64_C(   596.83), EASYSIMD_FLOAT64_C(  -871.46), EASYSIMD_FLOAT64_C(  -220.73), EASYSIMD_FLOAT64_C(     0.00) } },
    { UINT8_C(143),
      { EASYSIMD_FLOAT64_C(  -975.69), EASYSIMD_FLOAT64_C(  -293.66), EASYSIMD_FLOAT64_C(  -314.85), EASYSIMD_FLOAT64_C(  -720.20),
        EASYSIMD_FLOAT64_C(   714.21), EASYSIMD_FLOAT64_C(  -592.83), EASYSIMD_FLOAT64_C(   795.13), EASYSIMD_FLOAT64_C(  -193.07) },
       INT32_C(         146),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -975.69), EASYSIMD_FLOAT64_C(  -293.66), EASYSIMD_FLOAT64_C(  -314.85), EASYSIMD_FLOAT64_C(  -720.20),
        EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -193.07) } },
    { UINT8_C( 78),
      { EASYSIMD_FLOAT64_C(   266.27), EASYSIMD_FLOAT64_C(   999.77), EASYSIMD_FLOAT64_C(  -432.85), EASYSIMD_FLOAT64_C(  -229.42),
        EASYSIMD_FLOAT64_C(   135.60), EASYSIMD_FLOAT64_C(  -650.90), EASYSIMD_FLOAT64_C(   385.97), EASYSIMD_FLOAT64_C(   743.01) },
       INT32_C(         243),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   999.77), EASYSIMD_FLOAT64_C(  -432.85), EASYSIMD_FLOAT64_C(  -229.42),
        EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   385.97), EASYSIMD_FLOAT64_C(     0.00) } },
    { UINT8_C(153),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -258.22), EASYSIMD_FLOAT64_C(   643.08), EASYSIMD_FLOAT64_C(  -777.45),
        EASYSIMD_FLOAT64_C(   864.04), EASYSIMD_FLOAT64_C(  -328.14), EASYSIMD_FLOAT64_C(  -310.52), EASYSIMD_FLOAT64_C(   888.34) },
       INT32_C(         148),
       INT32_C(           8),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -777.45),
        EASYSIMD_FLOAT64_C(   864.04), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   888.34) } },
    { UINT8_C(203),
      { EASYSIMD_FLOAT64_C(   963.27), EASYSIMD_FLOAT64_C(   899.35), EASYSIMD_FLOAT64_C(    90.33), EASYSIMD_FLOAT64_C(  -950.68),
        EASYSIMD_FLOAT64_C(  -848.37), EASYSIMD_FLOAT64_C(   269.40), EASYSIMD_FLOAT64_C(   315.60), EASYSIMD_FLOAT64_C(  -848.60) },
       INT32_C(           0),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(   963.00), EASYSIMD_FLOAT64_C(   899.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -951.00),
        EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   316.00), EASYSIMD_FLOAT64_C(  -849.00) } },
    { UINT8_C(164),
      { EASYSIMD_FLOAT64_C(   472.15),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   147.65), EASYSIMD_FLOAT64_C(   957.14),
        EASYSIMD_FLOAT64_C(  -630.15), EASYSIMD_FLOAT64_C(  -761.81), EASYSIMD_FLOAT64_C(   221.41), EASYSIMD_FLOAT64_C(   111.62) },
       INT32_C(          17),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   147.50), EASYSIMD_FLOAT64_C(     0.00),
        EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -762.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   111.50) } },
    { UINT8_C(143),
      { EASYSIMD_FLOAT64_C(   931.35),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(    32.15), EASYSIMD_FLOAT64_C(    23.77),
        EASYSIMD_FLOAT64_C(   289.88), EASYSIMD_FLOAT64_C(    -4.58), EASYSIMD_FLOAT64_C(   -76.88), EASYSIMD_FLOAT64_C(  -619.79) },
       INT32_C(          18),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(   931.50),        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(    32.50), EASYSIMD_FLOAT64_C(    24.00),
        EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -619.50) } },
  };

  easysimd__m512d a, r;

  a = easysimd_mm512_loadu_pd(test_vec[0].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[0].k, a, INT32_C(         176), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[0].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[1].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[1].k, a, INT32_C(         193), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[1].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[2].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[2].k, a, INT32_C(         146), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[2].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[3].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[3].k, a, INT32_C(         243), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[3].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[4].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[4].k, a, INT32_C(         148), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[4].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[5].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[5].k, a, INT32_C(           0), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[5].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[6].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[6].k, a, INT32_C(          17), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[6].r), 1);

  a = easysimd_mm512_loadu_pd(test_vec[7].a);
  r = easysimd_mm512_maskz_roundscale_round_pd(test_vec[7].k, a, INT32_C(          18), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x8(r, easysimd_mm512_loadu_pd(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m512d a = easysimd_test_x86_random_f64x8(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        a = easysimd_mm512_mask_mov_pd(a, 1, easysimd_mm512_set1_pd(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          a = easysimd_mm512_mask_mov_pd(a, 2, easysimd_mm512_set1_pd(EASYSIMD_MATH_INFINITY));
        else
          a = easysimd_mm512_mask_mov_pd(a, 2, easysimd_mm512_set1_pd(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION : EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m512d r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm512_maskz_roundscale_round_pd, r, easysimd_mm512_setzero_pd(), imm8, sae, k, a);

    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_f64x8(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x8(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm_roundscale_round_ss (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float32 a[4];
    const easysimd_float32 b[4];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float32 r[4];
  } test_vec[] = {
    { { EASYSIMD_FLOAT32_C(   800.62), EASYSIMD_FLOAT32_C(     5.17), EASYSIMD_FLOAT32_C(   547.21), EASYSIMD_FLOAT32_C(   203.23) },
      { EASYSIMD_FLOAT32_C(  -972.56), EASYSIMD_FLOAT32_C(  -577.41), EASYSIMD_FLOAT32_C(   863.22), EASYSIMD_FLOAT32_C(  -460.21) },
       INT32_C(          48),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -972.50), EASYSIMD_FLOAT32_C(     5.17), EASYSIMD_FLOAT32_C(   547.21), EASYSIMD_FLOAT32_C(   203.23) } },
    { { EASYSIMD_FLOAT32_C(   180.26), EASYSIMD_FLOAT32_C(   -68.69), EASYSIMD_FLOAT32_C(  -107.59), EASYSIMD_FLOAT32_C(   332.04) },
      { EASYSIMD_FLOAT32_C(  -720.34), EASYSIMD_FLOAT32_C(  -229.64), EASYSIMD_FLOAT32_C(   714.58), EASYSIMD_FLOAT32_C(  -728.77) },
       INT32_C(          33),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -720.50), EASYSIMD_FLOAT32_C(   -68.69), EASYSIMD_FLOAT32_C(  -107.59), EASYSIMD_FLOAT32_C(   332.04) } },
    { { EASYSIMD_FLOAT32_C(   440.49), EASYSIMD_FLOAT32_C(  -146.35), EASYSIMD_FLOAT32_C(   642.47), EASYSIMD_FLOAT32_C(   445.00) },
      { EASYSIMD_FLOAT32_C(   258.97), EASYSIMD_FLOAT32_C(  -557.60), EASYSIMD_FLOAT32_C(    27.31), EASYSIMD_FLOAT32_C(   -55.97) },
       INT32_C(          98),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   258.98), EASYSIMD_FLOAT32_C(  -146.35), EASYSIMD_FLOAT32_C(   642.47), EASYSIMD_FLOAT32_C(   445.00) } },
    { { EASYSIMD_FLOAT32_C(  -315.92), EASYSIMD_FLOAT32_C(  -968.83), EASYSIMD_FLOAT32_C(   976.63), EASYSIMD_FLOAT32_C(   106.67) },
      {      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -483.58), EASYSIMD_FLOAT32_C(    91.58), EASYSIMD_FLOAT32_C(  -501.75) },
       INT32_C(         131),
       INT32_C(           4),
      {      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -968.83), EASYSIMD_FLOAT32_C(   976.63), EASYSIMD_FLOAT32_C(   106.67) } },
    { { EASYSIMD_FLOAT32_C(   709.22), EASYSIMD_FLOAT32_C(  -852.46), EASYSIMD_FLOAT32_C(   318.46), EASYSIMD_FLOAT32_C(   980.46) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -335.06), EASYSIMD_FLOAT32_C(  -155.61), EASYSIMD_FLOAT32_C(  -166.44) },
       INT32_C(         132),
       INT32_C(           8),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -852.46), EASYSIMD_FLOAT32_C(   318.46), EASYSIMD_FLOAT32_C(   980.46) } },
    { { EASYSIMD_FLOAT32_C(   -70.75), EASYSIMD_FLOAT32_C(   305.87), EASYSIMD_FLOAT32_C(   721.59), EASYSIMD_FLOAT32_C(  -933.87) },
      {     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   670.79), EASYSIMD_FLOAT32_C(  -249.78), EASYSIMD_FLOAT32_C(  -835.03) },
       INT32_C(         160),
       INT32_C(           8),
      {     -EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(   305.87), EASYSIMD_FLOAT32_C(   721.59), EASYSIMD_FLOAT32_C(  -933.87) } },
    { { EASYSIMD_FLOAT32_C(  -442.39), EASYSIMD_FLOAT32_C(  -351.39), EASYSIMD_FLOAT32_C(   220.31), EASYSIMD_FLOAT32_C(   987.17) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -175.80), EASYSIMD_FLOAT32_C(   696.40), EASYSIMD_FLOAT32_C(  -826.66) },
       INT32_C(          65),
       INT32_C(           8),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -351.39), EASYSIMD_FLOAT32_C(   220.31), EASYSIMD_FLOAT32_C(   987.17) } },
    { { EASYSIMD_FLOAT32_C(  -478.76), EASYSIMD_FLOAT32_C(  -600.03), EASYSIMD_FLOAT32_C(  -673.80), EASYSIMD_FLOAT32_C(     8.09) },
      { EASYSIMD_FLOAT32_C(  -321.46), EASYSIMD_FLOAT32_C(   103.77), EASYSIMD_FLOAT32_C(   937.35), EASYSIMD_FLOAT32_C(   984.41) },
       INT32_C(         146),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -321.46), EASYSIMD_FLOAT32_C(  -600.03), EASYSIMD_FLOAT32_C(  -673.80), EASYSIMD_FLOAT32_C(     8.09) } },
  };

  easysimd__m128 a, b, r;

  a = easysimd_mm_loadu_ps(test_vec[0].a);
  b = easysimd_mm_loadu_ps(test_vec[0].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(          48), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[0].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[1].a);
  b = easysimd_mm_loadu_ps(test_vec[1].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(          33), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[1].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[2].a);
  b = easysimd_mm_loadu_ps(test_vec[2].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(          98), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[2].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[3].a);
  b = easysimd_mm_loadu_ps(test_vec[3].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(         131), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[3].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[4].a);
  b = easysimd_mm_loadu_ps(test_vec[4].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(         132), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[4].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[5].a);
  b = easysimd_mm_loadu_ps(test_vec[5].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(         160), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[5].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[6].a);
  b = easysimd_mm_loadu_ps(test_vec[6].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(          65), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[6].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[7].a);
  b = easysimd_mm_loadu_ps(test_vec[7].b);
  r = easysimd_mm_roundscale_round_ss(a, b, INT32_C(         146), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m128 a = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    easysimd__m128 b = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(EASYSIMD_MATH_INFINITY));
        else
          b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION : EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m128 r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm_roundscale_round_ss, r, easysimd_mm_setzero_ps(), imm8, sae, a, b);

    easysimd_test_x86_write_f32x4(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_f32x4(2, b, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x4(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm_mask_roundscale_round_ss (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float32 src[4];
    const easysimd__mmask8 k;
    const easysimd_float32 a[4];
    const easysimd_float32 b[4];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float32 r[4];
  } test_vec[] = {
    { { EASYSIMD_FLOAT32_C(  -901.37), EASYSIMD_FLOAT32_C(   991.78), EASYSIMD_FLOAT32_C(  -993.88), EASYSIMD_FLOAT32_C(   421.48) },
      UINT8_C(125),
      { EASYSIMD_FLOAT32_C(   705.11), EASYSIMD_FLOAT32_C(  -569.84), EASYSIMD_FLOAT32_C(  -299.64), EASYSIMD_FLOAT32_C(  -705.39) },
      { EASYSIMD_FLOAT32_C(   431.44), EASYSIMD_FLOAT32_C(   682.16), EASYSIMD_FLOAT32_C(   342.34), EASYSIMD_FLOAT32_C(  -645.40) },
       INT32_C(         160),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   431.44), EASYSIMD_FLOAT32_C(  -569.84), EASYSIMD_FLOAT32_C(  -299.64), EASYSIMD_FLOAT32_C(  -705.39) } },
    { { EASYSIMD_FLOAT32_C(   935.70), EASYSIMD_FLOAT32_C(   772.61), EASYSIMD_FLOAT32_C(  -364.40), EASYSIMD_FLOAT32_C(   382.32) },
      UINT8_C(218),
      { EASYSIMD_FLOAT32_C(   -42.14), EASYSIMD_FLOAT32_C(   962.15), EASYSIMD_FLOAT32_C(   558.00), EASYSIMD_FLOAT32_C(   190.11) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   104.40), EASYSIMD_FLOAT32_C(   182.55), EASYSIMD_FLOAT32_C(   334.92) },
       INT32_C(          33),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   935.70), EASYSIMD_FLOAT32_C(   962.15), EASYSIMD_FLOAT32_C(   558.00), EASYSIMD_FLOAT32_C(   190.11) } },
    { { EASYSIMD_FLOAT32_C(    53.35), EASYSIMD_FLOAT32_C(  -144.97), EASYSIMD_FLOAT32_C(   718.45), EASYSIMD_FLOAT32_C(  -241.54) },
      UINT8_C(243),
      { EASYSIMD_FLOAT32_C(  -581.19), EASYSIMD_FLOAT32_C(    53.08), EASYSIMD_FLOAT32_C(  -283.38), EASYSIMD_FLOAT32_C(  -899.03) },
      { EASYSIMD_FLOAT32_C(  -604.58), EASYSIMD_FLOAT32_C(    71.23), EASYSIMD_FLOAT32_C(   989.92), EASYSIMD_FLOAT32_C(  -662.30) },
       INT32_C(          66),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -604.56), EASYSIMD_FLOAT32_C(    53.08), EASYSIMD_FLOAT32_C(  -283.38), EASYSIMD_FLOAT32_C(  -899.03) } },
    { { EASYSIMD_FLOAT32_C(  -529.80), EASYSIMD_FLOAT32_C(   307.93), EASYSIMD_FLOAT32_C(  -992.43), EASYSIMD_FLOAT32_C(   428.06) },
      UINT8_C( 78),
      { EASYSIMD_FLOAT32_C(   565.57), EASYSIMD_FLOAT32_C(  -381.83), EASYSIMD_FLOAT32_C(     4.93), EASYSIMD_FLOAT32_C(  -330.03) },
      { EASYSIMD_FLOAT32_C(   800.71), EASYSIMD_FLOAT32_C(  -660.15), EASYSIMD_FLOAT32_C(  -384.42), EASYSIMD_FLOAT32_C(  -152.05) },
       INT32_C(         211),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(  -529.80), EASYSIMD_FLOAT32_C(  -381.83), EASYSIMD_FLOAT32_C(     4.93), EASYSIMD_FLOAT32_C(  -330.03) } },
    { { EASYSIMD_FLOAT32_C(  -371.56), EASYSIMD_FLOAT32_C(  -728.57), EASYSIMD_FLOAT32_C(  -340.23), EASYSIMD_FLOAT32_C(   913.62) },
      UINT8_C( 96),
      { EASYSIMD_FLOAT32_C(   712.85), EASYSIMD_FLOAT32_C(  -369.75), EASYSIMD_FLOAT32_C(  -208.79), EASYSIMD_FLOAT32_C(  -891.73) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -218.88), EASYSIMD_FLOAT32_C(  -554.03), EASYSIMD_FLOAT32_C(   536.07) },
       INT32_C(         116),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(  -371.56), EASYSIMD_FLOAT32_C(  -369.75), EASYSIMD_FLOAT32_C(  -208.79), EASYSIMD_FLOAT32_C(  -891.73) } },
    { { EASYSIMD_FLOAT32_C(  -436.15), EASYSIMD_FLOAT32_C(   434.32), EASYSIMD_FLOAT32_C(   284.76), EASYSIMD_FLOAT32_C(  -870.58) },
      UINT8_C( 55),
      { EASYSIMD_FLOAT32_C(  -710.31), EASYSIMD_FLOAT32_C(  -200.61), EASYSIMD_FLOAT32_C(   853.20), EASYSIMD_FLOAT32_C(  -370.45) },
      { EASYSIMD_FLOAT32_C(   414.97), EASYSIMD_FLOAT32_C(  -298.84), EASYSIMD_FLOAT32_C(  -597.05), EASYSIMD_FLOAT32_C(   967.94) },
       INT32_C(           0),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(   415.00), EASYSIMD_FLOAT32_C(  -200.61), EASYSIMD_FLOAT32_C(   853.20), EASYSIMD_FLOAT32_C(  -370.45) } },
    { { EASYSIMD_FLOAT32_C(   262.23), EASYSIMD_FLOAT32_C(   -54.99), EASYSIMD_FLOAT32_C(   -70.40), EASYSIMD_FLOAT32_C(   -24.92) },
      UINT8_C(133),
      { EASYSIMD_FLOAT32_C(   720.81), EASYSIMD_FLOAT32_C(    83.35), EASYSIMD_FLOAT32_C(   276.74), EASYSIMD_FLOAT32_C(  -498.07) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -187.19), EASYSIMD_FLOAT32_C(   208.67), EASYSIMD_FLOAT32_C(  -914.41) },
       INT32_C(         113),
       INT32_C(           4),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(    83.35), EASYSIMD_FLOAT32_C(   276.74), EASYSIMD_FLOAT32_C(  -498.07) } },
    { { EASYSIMD_FLOAT32_C(  -491.89), EASYSIMD_FLOAT32_C(  -221.14), EASYSIMD_FLOAT32_C(  -694.11), EASYSIMD_FLOAT32_C(  -202.20) },
      UINT8_C( 29),
      { EASYSIMD_FLOAT32_C(  -840.90), EASYSIMD_FLOAT32_C(   427.35), EASYSIMD_FLOAT32_C(    -6.78), EASYSIMD_FLOAT32_C(  -139.75) },
      { EASYSIMD_FLOAT32_C(   830.30), EASYSIMD_FLOAT32_C(   -38.84), EASYSIMD_FLOAT32_C(   462.72), EASYSIMD_FLOAT32_C(  -138.30) },
       INT32_C(         114),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(   830.30), EASYSIMD_FLOAT32_C(   427.35), EASYSIMD_FLOAT32_C(    -6.78), EASYSIMD_FLOAT32_C(  -139.75) } },
  };

  easysimd__m128 src, a, b, r;

  src = easysimd_mm_loadu_ps(test_vec[0].src);
  a = easysimd_mm_loadu_ps(test_vec[0].a);
  b = easysimd_mm_loadu_ps(test_vec[0].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[0].k, a, b, INT32_C(         160), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[0].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[1].src);
  a = easysimd_mm_loadu_ps(test_vec[1].a);
  b = easysimd_mm_loadu_ps(test_vec[1].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[1].k, a, b, INT32_C(          33), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[1].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[2].src);
  a = easysimd_mm_loadu_ps(test_vec[2].a);
  b = easysimd_mm_loadu_ps(test_vec[2].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[2].k, a, b, INT32_C(          66), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[2].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[3].src);
  a = easysimd_mm_loadu_ps(test_vec[3].a);
  b = easysimd_mm_loadu_ps(test_vec[3].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[3].k, a, b, INT32_C(         211), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[3].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[4].src);
  a = easysimd_mm_loadu_ps(test_vec[4].a);
  b = easysimd_mm_loadu_ps(test_vec[4].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[4].k, a, b, INT32_C(         116), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[4].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[5].src);
  a = easysimd_mm_loadu_ps(test_vec[5].a);
  b = easysimd_mm_loadu_ps(test_vec[5].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[5].k, a, b, INT32_C(           0), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[5].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[6].src);
  a = easysimd_mm_loadu_ps(test_vec[6].a);
  b = easysimd_mm_loadu_ps(test_vec[6].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[6].k, a, b, INT32_C(         113), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[6].r), 1);

  src = easysimd_mm_loadu_ps(test_vec[7].src);
  a = easysimd_mm_loadu_ps(test_vec[7].a);
  b = easysimd_mm_loadu_ps(test_vec[7].b);
  r = easysimd_mm_mask_roundscale_round_ss(src, test_vec[7].k, a, b, INT32_C(         114), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m128 src = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m128 a = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    easysimd__m128 b = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(EASYSIMD_MATH_INFINITY));
        else
          b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION : EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m128 r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm_mask_roundscale_round_ss, r, easysimd_mm_setzero_ps(), imm8, sae, src, k, a, b);

    easysimd_test_x86_write_f32x4(2, src, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x4(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x4(2, b, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x4(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm_maskz_roundscale_round_ss (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd__mmask8 k;
    const easysimd_float32 a[4];
    const easysimd_float32 b[4];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float32 r[4];
  } test_vec[] = {
    { UINT8_C(128),
      { EASYSIMD_FLOAT32_C(   700.03), EASYSIMD_FLOAT32_C(   381.97), EASYSIMD_FLOAT32_C(   850.94), EASYSIMD_FLOAT32_C(  -216.62) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -647.13), EASYSIMD_FLOAT32_C(  -687.31), EASYSIMD_FLOAT32_C(   471.52) },
       INT32_C(           0),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(   381.97), EASYSIMD_FLOAT32_C(   850.94), EASYSIMD_FLOAT32_C(  -216.62) } },
    { UINT8_C( 36),
      { EASYSIMD_FLOAT32_C(  -456.00), EASYSIMD_FLOAT32_C(   293.00), EASYSIMD_FLOAT32_C(   826.59), EASYSIMD_FLOAT32_C(  -150.11) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   404.84), EASYSIMD_FLOAT32_C(     8.98), EASYSIMD_FLOAT32_C(   518.15) },
       INT32_C(          97),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(   293.00), EASYSIMD_FLOAT32_C(   826.59), EASYSIMD_FLOAT32_C(  -150.11) } },
    { UINT8_C( 80),
      { EASYSIMD_FLOAT32_C(  -789.85), EASYSIMD_FLOAT32_C(  -440.26), EASYSIMD_FLOAT32_C(  -943.10), EASYSIMD_FLOAT32_C(  -983.14) },
      { EASYSIMD_FLOAT32_C(  -310.13), EASYSIMD_FLOAT32_C(   756.93), EASYSIMD_FLOAT32_C(   398.83), EASYSIMD_FLOAT32_C(  -459.18) },
       INT32_C(           2),
       INT32_C(           4),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -440.26), EASYSIMD_FLOAT32_C(  -943.10), EASYSIMD_FLOAT32_C(  -983.14) } },
    { UINT8_C(  2),
      { EASYSIMD_FLOAT32_C(   529.06), EASYSIMD_FLOAT32_C(  -544.76), EASYSIMD_FLOAT32_C(   251.28), EASYSIMD_FLOAT32_C(   819.65) },
      { EASYSIMD_FLOAT32_C(   240.13), EASYSIMD_FLOAT32_C(  -700.99), EASYSIMD_FLOAT32_C(  -636.35), EASYSIMD_FLOAT32_C(  -466.87) },
       INT32_C(          83),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(  -544.76), EASYSIMD_FLOAT32_C(   251.28), EASYSIMD_FLOAT32_C(   819.65) } },
    { UINT8_C(253),
      { EASYSIMD_FLOAT32_C(  -777.48), EASYSIMD_FLOAT32_C(  -857.91), EASYSIMD_FLOAT32_C(   928.50), EASYSIMD_FLOAT32_C(  -908.25) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(   287.72), EASYSIMD_FLOAT32_C(   423.71), EASYSIMD_FLOAT32_C(   700.70) },
       INT32_C(         180),
       INT32_C(           8),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -857.91), EASYSIMD_FLOAT32_C(   928.50), EASYSIMD_FLOAT32_C(  -908.25) } },
    { UINT8_C(193),
      { EASYSIMD_FLOAT32_C(   116.39), EASYSIMD_FLOAT32_C(    78.15), EASYSIMD_FLOAT32_C(   777.83), EASYSIMD_FLOAT32_C(   173.93) },
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(  -369.17), EASYSIMD_FLOAT32_C(  -297.02), EASYSIMD_FLOAT32_C(  -572.92) },
       INT32_C(         128),
       INT32_C(           4),
      {            EASYSIMD_MATH_NANF, EASYSIMD_FLOAT32_C(    78.15), EASYSIMD_FLOAT32_C(   777.83), EASYSIMD_FLOAT32_C(   173.93) } },
    { UINT8_C(155),
      { EASYSIMD_FLOAT32_C(  -799.66), EASYSIMD_FLOAT32_C(  -693.28), EASYSIMD_FLOAT32_C(  -900.19), EASYSIMD_FLOAT32_C(  -175.72) },
      { EASYSIMD_FLOAT32_C(   837.16), EASYSIMD_FLOAT32_C(  -677.67), EASYSIMD_FLOAT32_C(   -33.63), EASYSIMD_FLOAT32_C(   765.66) },
       INT32_C(         241),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(   837.16), EASYSIMD_FLOAT32_C(  -693.28), EASYSIMD_FLOAT32_C(  -900.19), EASYSIMD_FLOAT32_C(  -175.72) } },
    { UINT8_C( 22),
      { EASYSIMD_FLOAT32_C(  -842.39), EASYSIMD_FLOAT32_C(   -99.15), EASYSIMD_FLOAT32_C(   318.40), EASYSIMD_FLOAT32_C(   875.17) },
      {      EASYSIMD_MATH_INFINITYF, EASYSIMD_FLOAT32_C(  -444.07), EASYSIMD_FLOAT32_C(    -8.44), EASYSIMD_FLOAT32_C(  -483.66) },
       INT32_C(          50),
       INT32_C(           8),
      { EASYSIMD_FLOAT32_C(     0.00), EASYSIMD_FLOAT32_C(   -99.15), EASYSIMD_FLOAT32_C(   318.40), EASYSIMD_FLOAT32_C(   875.17) } },
  };

  easysimd__m128 a, b, r;

  a = easysimd_mm_loadu_ps(test_vec[0].a);
  b = easysimd_mm_loadu_ps(test_vec[0].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[0].k, a, b, INT32_C(           0), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[0].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[1].a);
  b = easysimd_mm_loadu_ps(test_vec[1].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[1].k, a, b, INT32_C(          97), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[1].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[2].a);
  b = easysimd_mm_loadu_ps(test_vec[2].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[2].k, a, b, INT32_C(           2), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[2].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[3].a);
  b = easysimd_mm_loadu_ps(test_vec[3].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[3].k, a, b, INT32_C(          83), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[3].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[4].a);
  b = easysimd_mm_loadu_ps(test_vec[4].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[4].k, a, b, INT32_C(         180), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[4].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[5].a);
  b = easysimd_mm_loadu_ps(test_vec[5].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[5].k, a, b, INT32_C(         128), INT32_C(           4));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[5].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[6].a);
  b = easysimd_mm_loadu_ps(test_vec[6].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[6].k, a, b, INT32_C(         241), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[6].r), 1);

  a = easysimd_mm_loadu_ps(test_vec[7].a);
  b = easysimd_mm_loadu_ps(test_vec[7].b);
  r = easysimd_mm_maskz_roundscale_round_ss(test_vec[7].k, a, b, INT32_C(          50), INT32_C(           8));
  easysimd_test_x86_assert_equal_f32x4(r, easysimd_mm_loadu_ps(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m128 a = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    easysimd__m128 b = easysimd_test_x86_random_f32x4(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(EASYSIMD_MATH_INFINITY));
        else
          b = easysimd_mm_mask_mov_ps(b, 1, easysimd_mm_set1_ps(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_CUR_DIRECTION : EASYSIMD_MM_FROUND_NO_EXC;
    easysimd__m128 r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm_maskz_roundscale_round_ss, r, easysimd_mm_setzero_ps(), imm8, sae, k, a, b);

    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_f32x4(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x4(2, b, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f32x4(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm_roundscale_round_sd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float64 a[2];
    const easysimd_float64 b[2];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float64 r[2];
  } test_vec[] = {
    { { EASYSIMD_FLOAT64_C(  -922.84), EASYSIMD_FLOAT64_C(   174.41) },
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -819.78) },
       INT32_C(          64),
       INT32_C(           8),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   174.41) } },
    { { EASYSIMD_FLOAT64_C(  -239.65), EASYSIMD_FLOAT64_C(  -886.64) },
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -376.97) },
       INT32_C(          97),
       INT32_C(           4),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -886.64) } },
    { { EASYSIMD_FLOAT64_C(   481.56), EASYSIMD_FLOAT64_C(  -294.29) },
      { EASYSIMD_FLOAT64_C(   -38.63), EASYSIMD_FLOAT64_C(   396.57) },
       INT32_C(         210),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(   -38.63), EASYSIMD_FLOAT64_C(  -294.29) } },
    { { EASYSIMD_FLOAT64_C(   243.93), EASYSIMD_FLOAT64_C(   311.65) },
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   681.34) },
       INT32_C(          19),
       INT32_C(           8),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   311.65) } },
    { { EASYSIMD_FLOAT64_C(  -476.93), EASYSIMD_FLOAT64_C(   188.19) },
      { EASYSIMD_FLOAT64_C(   352.72), EASYSIMD_FLOAT64_C(  -296.71) },
       INT32_C(          84),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(   352.72), EASYSIMD_FLOAT64_C(   188.19) } },
    { { EASYSIMD_FLOAT64_C(  -150.31), EASYSIMD_FLOAT64_C(   102.87) },
      {       -EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   796.03) },
       INT32_C(         240),
       INT32_C(           4),
      {       -EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   102.87) } },
    { { EASYSIMD_FLOAT64_C(   614.65), EASYSIMD_FLOAT64_C(  -800.95) },
      {       -EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(    11.22) },
       INT32_C(          33),
       INT32_C(           8),
      {       -EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(  -800.95) } },
    { { EASYSIMD_FLOAT64_C(  -451.36), EASYSIMD_FLOAT64_C(  -912.02) },
      { EASYSIMD_FLOAT64_C(  -391.41), EASYSIMD_FLOAT64_C(    -5.45) },
       INT32_C(         162),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -391.41), EASYSIMD_FLOAT64_C(  -912.02) } },
  };

  easysimd__m128d a, b, r;

  a = easysimd_mm_loadu_pd(test_vec[0].a);
  b = easysimd_mm_loadu_pd(test_vec[0].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(          64), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[0].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[1].a);
  b = easysimd_mm_loadu_pd(test_vec[1].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(          97), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[1].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[2].a);
  b = easysimd_mm_loadu_pd(test_vec[2].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(         210), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[2].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[3].a);
  b = easysimd_mm_loadu_pd(test_vec[3].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(          19), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[3].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[4].a);
  b = easysimd_mm_loadu_pd(test_vec[4].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(          84), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[4].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[5].a);
  b = easysimd_mm_loadu_pd(test_vec[5].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(         240), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[5].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[6].a);
  b = easysimd_mm_loadu_pd(test_vec[6].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(          33), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[6].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[7].a);
  b = easysimd_mm_loadu_pd(test_vec[7].b);
  r = easysimd_mm_roundscale_round_sd(a, b, INT32_C(         162), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m128d a = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    easysimd__m128d b = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(EASYSIMD_MATH_INFINITY));
        else
          b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = easysimd_test_codegen_rand() & 1 ? EASYSIMD_MM_FROUND_NO_EXC : EASYSIMD_MM_FROUND_CUR_DIRECTION;
    easysimd__m128d r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm_roundscale_round_sd, r, easysimd_mm_setzero_pd(), imm8, sae, a, b);

    easysimd_test_x86_write_f64x2(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_f64x2(2, b, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x2(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm_mask_roundscale_round_sd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float64 src[2];
    const easysimd__mmask8 k;
    const easysimd_float64 a[2];
    const easysimd_float64 b[2];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float64 r[2];
  } test_vec[] = {
    { { EASYSIMD_FLOAT64_C(   874.86), EASYSIMD_FLOAT64_C(   394.65) },
      UINT8_C( 58),
      { EASYSIMD_FLOAT64_C(   201.75), EASYSIMD_FLOAT64_C(   815.04) },
      { EASYSIMD_FLOAT64_C(  -159.78), EASYSIMD_FLOAT64_C(   969.89) },
       INT32_C(         128),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(   874.86), EASYSIMD_FLOAT64_C(   815.04) } },
    { { EASYSIMD_FLOAT64_C(  -740.35), EASYSIMD_FLOAT64_C(  -485.55) },
      UINT8_C( 56),
      { EASYSIMD_FLOAT64_C(   387.51), EASYSIMD_FLOAT64_C(  -803.37) },
      { EASYSIMD_FLOAT64_C(  -180.68), EASYSIMD_FLOAT64_C(  -444.72) },
       INT32_C(          17),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -740.35), EASYSIMD_FLOAT64_C(  -803.37) } },
    { { EASYSIMD_FLOAT64_C(  -952.30), EASYSIMD_FLOAT64_C(   509.81) },
      UINT8_C(124),
      { EASYSIMD_FLOAT64_C(  -488.08), EASYSIMD_FLOAT64_C(  -565.90) },
      { EASYSIMD_FLOAT64_C(   427.29), EASYSIMD_FLOAT64_C(   560.52) },
       INT32_C(         194),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -952.30), EASYSIMD_FLOAT64_C(  -565.90) } },
    { { EASYSIMD_FLOAT64_C(  -643.85), EASYSIMD_FLOAT64_C(   123.00) },
      UINT8_C(217),
      { EASYSIMD_FLOAT64_C(   346.67), EASYSIMD_FLOAT64_C(  -675.25) },
      { EASYSIMD_FLOAT64_C(   842.99), EASYSIMD_FLOAT64_C(  -813.12) },
       INT32_C(          67),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(   842.94), EASYSIMD_FLOAT64_C(  -675.25) } },
    { { EASYSIMD_FLOAT64_C(  -850.89), EASYSIMD_FLOAT64_C(   -19.24) },
      UINT8_C(208),
      { EASYSIMD_FLOAT64_C(  -410.70), EASYSIMD_FLOAT64_C(  -631.73) },
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   408.62) },
       INT32_C(          20),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(  -850.89), EASYSIMD_FLOAT64_C(  -631.73) } },
    { { EASYSIMD_FLOAT64_C(  -431.37), EASYSIMD_FLOAT64_C(   805.13) },
      UINT8_C(  6),
      { EASYSIMD_FLOAT64_C(    80.55), EASYSIMD_FLOAT64_C(  -760.78) },
      {        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(  -358.93) },
       INT32_C(         160),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(  -431.37), EASYSIMD_FLOAT64_C(  -760.78) } },
    { { EASYSIMD_FLOAT64_C(   302.34), EASYSIMD_FLOAT64_C(  -502.96) },
      UINT8_C(109),
      { EASYSIMD_FLOAT64_C(   145.33), EASYSIMD_FLOAT64_C(  -316.07) },
      { EASYSIMD_FLOAT64_C(   771.91), EASYSIMD_FLOAT64_C(   866.44) },
       INT32_C(         113),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(   771.91), EASYSIMD_FLOAT64_C(  -316.07) } },
    { { EASYSIMD_FLOAT64_C(  -661.10), EASYSIMD_FLOAT64_C(  -489.68) },
      UINT8_C( 18),
      { EASYSIMD_FLOAT64_C(  -379.76), EASYSIMD_FLOAT64_C(   918.95) },
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(   141.17) },
       INT32_C(         242),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(  -661.10), EASYSIMD_FLOAT64_C(   918.95) } },
  };

  easysimd__m128d src, a, b, r;

  src = easysimd_mm_loadu_pd(test_vec[0].src);
  a = easysimd_mm_loadu_pd(test_vec[0].a);
  b = easysimd_mm_loadu_pd(test_vec[0].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[0].k, a, b, INT32_C(         128), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[0].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[1].src);
  a = easysimd_mm_loadu_pd(test_vec[1].a);
  b = easysimd_mm_loadu_pd(test_vec[1].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[1].k, a, b, INT32_C(          17), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[1].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[2].src);
  a = easysimd_mm_loadu_pd(test_vec[2].a);
  b = easysimd_mm_loadu_pd(test_vec[2].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[2].k, a, b, INT32_C(         194), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[2].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[3].src);
  a = easysimd_mm_loadu_pd(test_vec[3].a);
  b = easysimd_mm_loadu_pd(test_vec[3].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[3].k, a, b, INT32_C(          67), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[3].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[4].src);
  a = easysimd_mm_loadu_pd(test_vec[4].a);
  b = easysimd_mm_loadu_pd(test_vec[4].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[4].k, a, b, INT32_C(          20), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[4].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[5].src);
  a = easysimd_mm_loadu_pd(test_vec[5].a);
  b = easysimd_mm_loadu_pd(test_vec[5].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[5].k, a, b, INT32_C(         160), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[5].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[6].src);
  a = easysimd_mm_loadu_pd(test_vec[6].a);
  b = easysimd_mm_loadu_pd(test_vec[6].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[6].k, a, b, INT32_C(         113), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[6].r), 1);

  src = easysimd_mm_loadu_pd(test_vec[7].src);
  a = easysimd_mm_loadu_pd(test_vec[7].a);
  b = easysimd_mm_loadu_pd(test_vec[7].b);
  r = easysimd_mm_mask_roundscale_round_sd(src, test_vec[7].k, a, b, INT32_C(         242), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m128d src = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m128d a = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    easysimd__m128d b = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(EASYSIMD_MATH_INFINITY));
        else
          b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = easysimd_test_codegen_rand() & 1 ? EASYSIMD_MM_FROUND_NO_EXC : EASYSIMD_MM_FROUND_CUR_DIRECTION;
    easysimd__m128d r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm_mask_roundscale_round_sd, r, easysimd_mm_setzero_pd(), imm8, sae, src, k, a, b);

    easysimd_test_x86_write_f64x2(2, src, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x2(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x2(2, b, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x2(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm_maskz_roundscale_round_sd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd__mmask8 k;
    const easysimd_float64 a[2];
    const easysimd_float64 b[2];
    const int32_t imm8;
    const int32_t sae;
    const easysimd_float64 r[2];
  } test_vec[] = {
    { UINT8_C( 24),
      { EASYSIMD_FLOAT64_C(   182.09), EASYSIMD_FLOAT64_C(  -254.56) },
      {        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(  -862.84) },
       INT32_C(         208),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -254.56) } },
    { UINT8_C(155),
      { EASYSIMD_FLOAT64_C(  -276.68), EASYSIMD_FLOAT64_C(  -318.19) },
      { EASYSIMD_FLOAT64_C(   579.53), EASYSIMD_FLOAT64_C(   929.18) },
       INT32_C(          97),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(   579.52), EASYSIMD_FLOAT64_C(  -318.19) } },
    { UINT8_C( 46),
      { EASYSIMD_FLOAT64_C(   499.87), EASYSIMD_FLOAT64_C(  -856.43) },
      {        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   509.56) },
       INT32_C(         210),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(  -856.43) } },
    { UINT8_C(127),
      { EASYSIMD_FLOAT64_C(   171.29), EASYSIMD_FLOAT64_C(  -814.14) },
      { EASYSIMD_FLOAT64_C(  -592.15), EASYSIMD_FLOAT64_C(  -646.63) },
       INT32_C(           3),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(  -592.00), EASYSIMD_FLOAT64_C(  -814.14) } },
    { UINT8_C(  4),
      { EASYSIMD_FLOAT64_C(   426.00), EASYSIMD_FLOAT64_C(   297.22) },
      {        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(   827.55) },
       INT32_C(         100),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   297.22) } },
    { UINT8_C( 33),
      { EASYSIMD_FLOAT64_C(   318.40), EASYSIMD_FLOAT64_C(     7.60) },
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(  -181.73) },
       INT32_C(          64),
       INT32_C(           4),
      {             EASYSIMD_MATH_NAN, EASYSIMD_FLOAT64_C(     7.60) } },
    { UINT8_C(188),
      { EASYSIMD_FLOAT64_C(  -686.65), EASYSIMD_FLOAT64_C(   152.96) },
      { EASYSIMD_FLOAT64_C(   752.21), EASYSIMD_FLOAT64_C(  -604.31) },
       INT32_C(         161),
       INT32_C(           4),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   152.96) } },
    { UINT8_C(182),
      { EASYSIMD_FLOAT64_C(  -130.62), EASYSIMD_FLOAT64_C(   -92.45) },
      {        EASYSIMD_MATH_INFINITY, EASYSIMD_FLOAT64_C(  -441.39) },
       INT32_C(          66),
       INT32_C(           8),
      { EASYSIMD_FLOAT64_C(     0.00), EASYSIMD_FLOAT64_C(   -92.45) } },
  };

  easysimd__m128d a, b, r;

  a = easysimd_mm_loadu_pd(test_vec[0].a);
  b = easysimd_mm_loadu_pd(test_vec[0].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[0].k, a, b, INT32_C(         208), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[0].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[1].a);
  b = easysimd_mm_loadu_pd(test_vec[1].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[1].k, a, b, INT32_C(          97), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[1].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[2].a);
  b = easysimd_mm_loadu_pd(test_vec[2].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[2].k, a, b, INT32_C(         210), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[2].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[3].a);
  b = easysimd_mm_loadu_pd(test_vec[3].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[3].k, a, b, INT32_C(           3), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[3].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[4].a);
  b = easysimd_mm_loadu_pd(test_vec[4].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[4].k, a, b, INT32_C(         100), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[4].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[5].a);
  b = easysimd_mm_loadu_pd(test_vec[5].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[5].k, a, b, INT32_C(          64), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[5].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[6].a);
  b = easysimd_mm_loadu_pd(test_vec[6].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[6].k, a, b, INT32_C(         161), INT32_C(           4));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[6].r), 1);

  a = easysimd_mm_loadu_pd(test_vec[7].a);
  b = easysimd_mm_loadu_pd(test_vec[7].b);
  r = easysimd_mm_maskz_roundscale_round_sd(test_vec[7].k, a, b, INT32_C(          66), INT32_C(           8));
  easysimd_test_x86_assert_equal_f64x2(r, easysimd_mm_loadu_pd(test_vec[7].r), 1);

  return 0;
#else
  fputc('\n', stdout);
  int round_type[5] = {EASYSIMD_MM_FROUND_TO_NEAREST_INT, EASYSIMD_MM_FROUND_TO_NEG_INF, EASYSIMD_MM_FROUND_TO_POS_INF, EASYSIMD_MM_FROUND_TO_ZERO, EASYSIMD_MM_FROUND_CUR_DIRECTION};
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__mmask8 k = easysimd_test_x86_random_mmask8();
    easysimd__m128d a = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    easysimd__m128d b = easysimd_test_x86_random_f64x2(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    if((easysimd_test_codegen_rand() & 1)) {
      if((easysimd_test_codegen_rand() & 1))
        b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(EASYSIMD_MATH_NAN));
      else {
        if((easysimd_test_codegen_rand() & 1))
          b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(EASYSIMD_MATH_INFINITY));
        else
          b = easysimd_mm_mask_mov_pd(b, 1, easysimd_mm_set1_pd(-EASYSIMD_MATH_INFINITY));
      }
    }
    int imm8 = (((easysimd_test_codegen_rand() & 15) << 4) | round_type[i % 5]) & 255;
    int sae = (easysimd_test_codegen_rand() & 1) ? EASYSIMD_MM_FROUND_NO_EXC : EASYSIMD_MM_FROUND_CUR_DIRECTION;
    easysimd__m128d r;
    EASYSIMD_CONSTIFY_256_NEW(easysimd_mm_maskz_roundscale_round_sd, r, easysimd_mm_setzero_pd(), imm8, sae, k, a, b);

    easysimd_test_x86_write_mmask8(2, k, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_x86_write_f64x2(2, a, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x2(2, b, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, imm8, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_codegen_write_i32(2, sae, EASYSIMD_TEST_VEC_POS_MIDDLE);
    easysimd_test_x86_write_f64x2(2, r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

EASYSIMD_TEST_FUNC_LIST_BEGIN
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_roundscale_round_ps)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_mask_roundscale_round_ps)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_maskz_roundscale_round_ps)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_roundscale_round_pd)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_mask_roundscale_round_pd)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_maskz_roundscale_round_pd)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_roundscale_round_ss)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_mask_roundscale_round_ss)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_maskz_roundscale_round_ss)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_roundscale_round_sd)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_mask_roundscale_round_sd)
  EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_maskz_roundscale_round_sd)
EASYSIMD_TEST_FUNC_LIST_END

#include <test/x86/avx512/test-avx512-footer.h>
