/* SPDX-License-Identifier: MIT
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Copyright:
 *   2020      Evan Nemerson <evan@nemerson.com>
 */

#define EASYSIMD_TEST_X86_AVX512_INSN store

#include <test/x86/avx512/test-avx512.h>
#include <easysimd/x86/avx512/store.h>

#ifndef easysimd_mm_set_epi32_reverse
#define easysimd_mm_set_epi32_reverse(op0, op1, op2, op3) easysimd_mm_set_epi32((op3), (op2), (op1), (op0))
#endif
#ifndef easysimd_mm_set_epi64_reverse
#define easysimd_mm_set_epi64_reverse(op0, op1) easysimd_mm_set_epi64x((op1), (op0))
#endif

static int
test_easysimd_mm_store_epi32(EASYSIMD_MUNIT_TEST_ARGS) {
  struct {
    easysimd__m128i a;
    int32_t r[4];
  } test_vec[8] = {
    { easysimd_mm_set_epi32_reverse(  INT32_C(   204703042),  INT32_C(  1405648455),  INT32_C(  1421679163), -INT32_C(  1240399630) ),
                                {  INT32_C(   204703042),  INT32_C(  1405648455),  INT32_C(  1421679163), -INT32_C(  1240399630) } },
    { easysimd_mm_set_epi32_reverse(  INT32_C(   632249171), -INT32_C(   200155326), -INT32_C(  1195604562), -INT32_C(  1490680987) ),
                                {  INT32_C(   632249171), -INT32_C(   200155326), -INT32_C(  1195604562), -INT32_C(  1490680987) } },
    { easysimd_mm_set_epi32_reverse( -INT32_C(   810329720),  INT32_C(   321092567), -INT32_C(  2006458218),  INT32_C(   876509409) ),
                                { -INT32_C(   810329720),  INT32_C(   321092567), -INT32_C(  2006458218),  INT32_C(   876509409) } },
    { easysimd_mm_set_epi32_reverse(  INT32_C(   375058131),  INT32_C(  2081057741),  INT32_C(  1429522160),  INT32_C(  1392270026) ),
                                {  INT32_C(   375058131),  INT32_C(  2081057741),  INT32_C(  1429522160),  INT32_C(  1392270026) } },
    { easysimd_mm_set_epi32_reverse( -INT32_C(  1960660813), -INT32_C(  1046592213),  INT32_C(   105448741),  INT32_C(  1346078845) ),
                                { -INT32_C(  1960660813), -INT32_C(  1046592213),  INT32_C(   105448741),  INT32_C(  1346078845) } },
    { easysimd_mm_set_epi32_reverse(  INT32_C(  1130796406), -INT32_C(   255889408),  INT32_C(    21427255),  INT32_C(    39010894) ),
                                {  INT32_C(  1130796406), -INT32_C(   255889408),  INT32_C(    21427255),  INT32_C(    39010894) } },
    { easysimd_mm_set_epi32_reverse(  INT32_C(   512587250), -INT32_C(   522245190), -INT32_C(  1377425104),  INT32_C(   670900657) ),
                                {  INT32_C(   512587250), -INT32_C(   522245190), -INT32_C(  1377425104),  INT32_C(   670900657) } },
    { easysimd_mm_set_epi32_reverse( -INT32_C(  1234541386),  INT32_C(   195504852),  INT32_C(  1812786462),  INT32_C(   577658927) ),
                                { -INT32_C(  1234541386),  INT32_C(   195504852),  INT32_C(  1812786462),  INT32_C(   577658927) } }
  };

  int32_t r[4];
  for (size_t i = 0 ; i < (sizeof(test_vec) / (sizeof(test_vec[0]))) ; i++) {
    easysimd__m128i a = test_vec[i].a;
    EASYSIMD_TEST_PERF_WITH_LOOP_START(100000) {
      easysimd_mm_store_epi32((void const *)r, a);
    }
    EASYSIMD_TEST_PERF_END("_mm_store_epi32 on easysimd");
    easysimd_assert_equal_vi32(sizeof(test_vec[i].r) / sizeof(test_vec[i].r[0]), r, test_vec[i].r);
  }

  return 0;
}

static int
test_easysimd_mm_store_epi64(EASYSIMD_MUNIT_TEST_ARGS) {
  struct {
    easysimd__m128i a;
    int64_t r[2];
  } test_vec[] = {
    { easysimd_mm_set_epi64_reverse( -INT64_C( 7545262301829905454), -INT64_C( 1958586321215385572) ),
                                { -INT64_C( 7545262301829905454), -INT64_C( 1958586321215385572) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 6939036072950037735),  INT64_C( 3607479373089500002) ),
                                {  INT64_C( 6939036072950037735),  INT64_C( 3607479373089500002) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 5411977855425599642), -INT64_C( 4915314144854859834) ),
                                {  INT64_C( 5411977855425599642), -INT64_C( 4915314144854859834) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 7003725240944465735), -INT64_C( 5748606240007012698) ),
                                {  INT64_C( 7003725240944465735), -INT64_C( 5748606240007012698) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 2354625429781095474), -INT64_C( 5116707715300448657) ),
                                {  INT64_C( 2354625429781095474), -INT64_C( 5116707715300448657) } },
    { easysimd_mm_set_epi64_reverse( -INT64_C( 3691055971501937563), -INT64_C( 7331848749136572549) ),
                                { -INT64_C( 3691055971501937563), -INT64_C( 7331848749136572549) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 3722693228592133167), -INT64_C( 2235628766796337713) ),
                                {  INT64_C( 3722693228592133167), -INT64_C( 2235628766796337713) } },
    { easysimd_mm_set_epi64_reverse( -INT64_C( 4948881768296709025),  INT64_C( 6817478069461984409) ),
                                { -INT64_C( 4948881768296709025),  INT64_C( 6817478069461984409) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 1294943505036580865),  INT64_C( 4582496049386646845) ),
                                {  INT64_C( 1294943505036580865),  INT64_C( 4582496049386646845) } },
    { easysimd_mm_set_epi64_reverse( -INT64_C( 9094148741358297649), -INT64_C( 6500911271087237317) ),
                                { -INT64_C( 9094148741358297649), -INT64_C( 6500911271087237317) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C( 9010122031415078840),  INT64_C( 8642353433853385935) ),
                                {  INT64_C( 9010122031415078840),  INT64_C( 8642353433853385935) } },
    { easysimd_mm_set_epi64_reverse(  INT64_C(  509843316624831659),  INT64_C( 7976783918604064362) ),
                                {  INT64_C(  509843316624831659),  INT64_C( 7976783918604064362) } },
  };

  int64_t r[2];
  for (size_t i = 0 ; i < (sizeof(test_vec) / (sizeof(test_vec[0]))) ; i++) {
    easysimd__m128i a = test_vec[i].a;
    EASYSIMD_TEST_PERF_WITH_LOOP_START(100000) {
      easysimd_mm_store_epi64((void const *)r, a);
    }
    EASYSIMD_TEST_PERF_END("_mm_store_epi64 on easysimd");
    easysimd_assert_equal_vi64(sizeof(test_vec[i].r) / sizeof(test_vec[i].r[0]), r, test_vec[i].r);
  }
  return 0;
}




static int
test_easysimd_mm512_store_ps (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float32 a[16];
    const easysimd_float32 r[16];
  } test_vec[] = {
    { { EASYSIMD_FLOAT32_C(   397.85), EASYSIMD_FLOAT32_C(   280.50), EASYSIMD_FLOAT32_C(  -482.10), EASYSIMD_FLOAT32_C(  -764.38),
        EASYSIMD_FLOAT32_C(   375.26), EASYSIMD_FLOAT32_C(  -613.57), EASYSIMD_FLOAT32_C(    56.03), EASYSIMD_FLOAT32_C(   417.16),
        EASYSIMD_FLOAT32_C(  -424.36), EASYSIMD_FLOAT32_C(    64.48), EASYSIMD_FLOAT32_C(     0.84), EASYSIMD_FLOAT32_C(   101.24),
        EASYSIMD_FLOAT32_C(  -965.83), EASYSIMD_FLOAT32_C(   916.49), EASYSIMD_FLOAT32_C(   799.09), EASYSIMD_FLOAT32_C(   628.08) },
      { EASYSIMD_FLOAT32_C(   397.85), EASYSIMD_FLOAT32_C(   280.50), EASYSIMD_FLOAT32_C(  -482.10), EASYSIMD_FLOAT32_C(  -764.38),
        EASYSIMD_FLOAT32_C(   375.26), EASYSIMD_FLOAT32_C(  -613.57), EASYSIMD_FLOAT32_C(    56.03), EASYSIMD_FLOAT32_C(   417.16),
        EASYSIMD_FLOAT32_C(  -424.36), EASYSIMD_FLOAT32_C(    64.48), EASYSIMD_FLOAT32_C(     0.84), EASYSIMD_FLOAT32_C(   101.24),
        EASYSIMD_FLOAT32_C(  -965.83), EASYSIMD_FLOAT32_C(   916.49), EASYSIMD_FLOAT32_C(   799.09), EASYSIMD_FLOAT32_C(   628.08) } },
    { { EASYSIMD_FLOAT32_C(  -588.70), EASYSIMD_FLOAT32_C(   688.61), EASYSIMD_FLOAT32_C(   202.01), EASYSIMD_FLOAT32_C(  -610.64),
        EASYSIMD_FLOAT32_C(   838.07), EASYSIMD_FLOAT32_C(  -733.40), EASYSIMD_FLOAT32_C(  -127.00), EASYSIMD_FLOAT32_C(   993.35),
        EASYSIMD_FLOAT32_C(  -249.66), EASYSIMD_FLOAT32_C(   -45.23), EASYSIMD_FLOAT32_C(   849.71), EASYSIMD_FLOAT32_C(   -85.52),
        EASYSIMD_FLOAT32_C(   193.59), EASYSIMD_FLOAT32_C(  -257.46), EASYSIMD_FLOAT32_C(   827.23), EASYSIMD_FLOAT32_C(  -408.56) },
      { EASYSIMD_FLOAT32_C(  -588.70), EASYSIMD_FLOAT32_C(   688.61), EASYSIMD_FLOAT32_C(   202.01), EASYSIMD_FLOAT32_C(  -610.64),
        EASYSIMD_FLOAT32_C(   838.07), EASYSIMD_FLOAT32_C(  -733.40), EASYSIMD_FLOAT32_C(  -127.00), EASYSIMD_FLOAT32_C(   993.35),
        EASYSIMD_FLOAT32_C(  -249.66), EASYSIMD_FLOAT32_C(   -45.23), EASYSIMD_FLOAT32_C(   849.71), EASYSIMD_FLOAT32_C(   -85.52),
        EASYSIMD_FLOAT32_C(   193.59), EASYSIMD_FLOAT32_C(  -257.46), EASYSIMD_FLOAT32_C(   827.23), EASYSIMD_FLOAT32_C(  -408.56) } },
    { { EASYSIMD_FLOAT32_C(  -976.96), EASYSIMD_FLOAT32_C(  -654.87), EASYSIMD_FLOAT32_C(  -172.94), EASYSIMD_FLOAT32_C(   398.29),
        EASYSIMD_FLOAT32_C(  -268.45), EASYSIMD_FLOAT32_C(   883.09), EASYSIMD_FLOAT32_C(  -184.55), EASYSIMD_FLOAT32_C(   307.20),
        EASYSIMD_FLOAT32_C(   -52.43), EASYSIMD_FLOAT32_C(   816.29), EASYSIMD_FLOAT32_C(  -591.56), EASYSIMD_FLOAT32_C(   -18.26),
        EASYSIMD_FLOAT32_C(   732.78), EASYSIMD_FLOAT32_C(  -792.48), EASYSIMD_FLOAT32_C(  -390.18), EASYSIMD_FLOAT32_C(  -855.92) },
      { EASYSIMD_FLOAT32_C(  -976.96), EASYSIMD_FLOAT32_C(  -654.87), EASYSIMD_FLOAT32_C(  -172.94), EASYSIMD_FLOAT32_C(   398.29),
        EASYSIMD_FLOAT32_C(  -268.45), EASYSIMD_FLOAT32_C(   883.09), EASYSIMD_FLOAT32_C(  -184.55), EASYSIMD_FLOAT32_C(   307.20),
        EASYSIMD_FLOAT32_C(   -52.43), EASYSIMD_FLOAT32_C(   816.29), EASYSIMD_FLOAT32_C(  -591.56), EASYSIMD_FLOAT32_C(   -18.26),
        EASYSIMD_FLOAT32_C(   732.78), EASYSIMD_FLOAT32_C(  -792.48), EASYSIMD_FLOAT32_C(  -390.18), EASYSIMD_FLOAT32_C(  -855.92) } },
    { { EASYSIMD_FLOAT32_C(   896.13), EASYSIMD_FLOAT32_C(   811.83), EASYSIMD_FLOAT32_C(  -466.56), EASYSIMD_FLOAT32_C(   734.20),
        EASYSIMD_FLOAT32_C(  -921.57), EASYSIMD_FLOAT32_C(   406.44), EASYSIMD_FLOAT32_C(   727.55), EASYSIMD_FLOAT32_C(  -171.23),
        EASYSIMD_FLOAT32_C(  -638.79), EASYSIMD_FLOAT32_C(   577.26), EASYSIMD_FLOAT32_C(   743.25), EASYSIMD_FLOAT32_C(   554.80),
        EASYSIMD_FLOAT32_C(  -680.21), EASYSIMD_FLOAT32_C(   570.48), EASYSIMD_FLOAT32_C(  -853.75), EASYSIMD_FLOAT32_C(  -657.17) },
      { EASYSIMD_FLOAT32_C(   896.13), EASYSIMD_FLOAT32_C(   811.83), EASYSIMD_FLOAT32_C(  -466.56), EASYSIMD_FLOAT32_C(   734.20),
        EASYSIMD_FLOAT32_C(  -921.57), EASYSIMD_FLOAT32_C(   406.44), EASYSIMD_FLOAT32_C(   727.55), EASYSIMD_FLOAT32_C(  -171.23),
        EASYSIMD_FLOAT32_C(  -638.79), EASYSIMD_FLOAT32_C(   577.26), EASYSIMD_FLOAT32_C(   743.25), EASYSIMD_FLOAT32_C(   554.80),
        EASYSIMD_FLOAT32_C(  -680.21), EASYSIMD_FLOAT32_C(   570.48), EASYSIMD_FLOAT32_C(  -853.75), EASYSIMD_FLOAT32_C(  -657.17) } },
    { { EASYSIMD_FLOAT32_C(   915.61), EASYSIMD_FLOAT32_C(   -26.70), EASYSIMD_FLOAT32_C(   741.12), EASYSIMD_FLOAT32_C(  -352.84),
        EASYSIMD_FLOAT32_C(  -143.61), EASYSIMD_FLOAT32_C(  -443.43), EASYSIMD_FLOAT32_C(   954.36), EASYSIMD_FLOAT32_C(   803.96),
        EASYSIMD_FLOAT32_C(  -627.14), EASYSIMD_FLOAT32_C(  -637.21), EASYSIMD_FLOAT32_C(  -214.30), EASYSIMD_FLOAT32_C(  -894.36),
        EASYSIMD_FLOAT32_C(  -429.68), EASYSIMD_FLOAT32_C(   395.52), EASYSIMD_FLOAT32_C(  -750.28), EASYSIMD_FLOAT32_C(  -533.55) },
      { EASYSIMD_FLOAT32_C(   915.61), EASYSIMD_FLOAT32_C(   -26.70), EASYSIMD_FLOAT32_C(   741.12), EASYSIMD_FLOAT32_C(  -352.84),
        EASYSIMD_FLOAT32_C(  -143.61), EASYSIMD_FLOAT32_C(  -443.43), EASYSIMD_FLOAT32_C(   954.36), EASYSIMD_FLOAT32_C(   803.96),
        EASYSIMD_FLOAT32_C(  -627.14), EASYSIMD_FLOAT32_C(  -637.21), EASYSIMD_FLOAT32_C(  -214.30), EASYSIMD_FLOAT32_C(  -894.36),
        EASYSIMD_FLOAT32_C(  -429.68), EASYSIMD_FLOAT32_C(   395.52), EASYSIMD_FLOAT32_C(  -750.28), EASYSIMD_FLOAT32_C(  -533.55) } },
    { { EASYSIMD_FLOAT32_C(   207.35), EASYSIMD_FLOAT32_C(  -216.84), EASYSIMD_FLOAT32_C(  -799.36), EASYSIMD_FLOAT32_C(   285.78),
        EASYSIMD_FLOAT32_C(  -810.40), EASYSIMD_FLOAT32_C(   928.19), EASYSIMD_FLOAT32_C(  -885.45), EASYSIMD_FLOAT32_C(  -449.19),
        EASYSIMD_FLOAT32_C(   505.45), EASYSIMD_FLOAT32_C(   857.81), EASYSIMD_FLOAT32_C(  -894.39), EASYSIMD_FLOAT32_C(   825.24),
        EASYSIMD_FLOAT32_C(   428.29), EASYSIMD_FLOAT32_C(  -748.14), EASYSIMD_FLOAT32_C(  -831.93), EASYSIMD_FLOAT32_C(   343.89) },
      { EASYSIMD_FLOAT32_C(   207.35), EASYSIMD_FLOAT32_C(  -216.84), EASYSIMD_FLOAT32_C(  -799.36), EASYSIMD_FLOAT32_C(   285.78),
        EASYSIMD_FLOAT32_C(  -810.40), EASYSIMD_FLOAT32_C(   928.19), EASYSIMD_FLOAT32_C(  -885.45), EASYSIMD_FLOAT32_C(  -449.19),
        EASYSIMD_FLOAT32_C(   505.45), EASYSIMD_FLOAT32_C(   857.81), EASYSIMD_FLOAT32_C(  -894.39), EASYSIMD_FLOAT32_C(   825.24),
        EASYSIMD_FLOAT32_C(   428.29), EASYSIMD_FLOAT32_C(  -748.14), EASYSIMD_FLOAT32_C(  -831.93), EASYSIMD_FLOAT32_C(   343.89) } },
    { { EASYSIMD_FLOAT32_C(   225.16), EASYSIMD_FLOAT32_C(   909.19), EASYSIMD_FLOAT32_C(   991.05), EASYSIMD_FLOAT32_C(  -918.45),
        EASYSIMD_FLOAT32_C(  -534.23), EASYSIMD_FLOAT32_C(   945.41), EASYSIMD_FLOAT32_C(   885.51), EASYSIMD_FLOAT32_C(  -161.37),
        EASYSIMD_FLOAT32_C(  -691.80), EASYSIMD_FLOAT32_C(  -328.80), EASYSIMD_FLOAT32_C(   -55.73), EASYSIMD_FLOAT32_C(  -121.48),
        EASYSIMD_FLOAT32_C(  -933.28), EASYSIMD_FLOAT32_C(   193.99), EASYSIMD_FLOAT32_C(   344.96), EASYSIMD_FLOAT32_C(   274.08) },
      { EASYSIMD_FLOAT32_C(   225.16), EASYSIMD_FLOAT32_C(   909.19), EASYSIMD_FLOAT32_C(   991.05), EASYSIMD_FLOAT32_C(  -918.45),
        EASYSIMD_FLOAT32_C(  -534.23), EASYSIMD_FLOAT32_C(   945.41), EASYSIMD_FLOAT32_C(   885.51), EASYSIMD_FLOAT32_C(  -161.37),
        EASYSIMD_FLOAT32_C(  -691.80), EASYSIMD_FLOAT32_C(  -328.80), EASYSIMD_FLOAT32_C(   -55.73), EASYSIMD_FLOAT32_C(  -121.48),
        EASYSIMD_FLOAT32_C(  -933.28), EASYSIMD_FLOAT32_C(   193.99), EASYSIMD_FLOAT32_C(   344.96), EASYSIMD_FLOAT32_C(   274.08) } },
    { { EASYSIMD_FLOAT32_C(   977.14), EASYSIMD_FLOAT32_C(   545.61), EASYSIMD_FLOAT32_C(  -440.14), EASYSIMD_FLOAT32_C(  -833.26),
        EASYSIMD_FLOAT32_C(   473.80), EASYSIMD_FLOAT32_C(  -325.59), EASYSIMD_FLOAT32_C(  -282.45), EASYSIMD_FLOAT32_C(   -20.75),
        EASYSIMD_FLOAT32_C(  -467.78), EASYSIMD_FLOAT32_C(  -176.84), EASYSIMD_FLOAT32_C(  -195.51), EASYSIMD_FLOAT32_C(   960.51),
        EASYSIMD_FLOAT32_C(    75.02), EASYSIMD_FLOAT32_C(   -27.44), EASYSIMD_FLOAT32_C(   304.40), EASYSIMD_FLOAT32_C(  -699.82) },
      { EASYSIMD_FLOAT32_C(   977.14), EASYSIMD_FLOAT32_C(   545.61), EASYSIMD_FLOAT32_C(  -440.14), EASYSIMD_FLOAT32_C(  -833.26),
        EASYSIMD_FLOAT32_C(   473.80), EASYSIMD_FLOAT32_C(  -325.59), EASYSIMD_FLOAT32_C(  -282.45), EASYSIMD_FLOAT32_C(   -20.75),
        EASYSIMD_FLOAT32_C(  -467.78), EASYSIMD_FLOAT32_C(  -176.84), EASYSIMD_FLOAT32_C(  -195.51), EASYSIMD_FLOAT32_C(   960.51),
        EASYSIMD_FLOAT32_C(    75.02), EASYSIMD_FLOAT32_C(   -27.44), EASYSIMD_FLOAT32_C(   304.40), EASYSIMD_FLOAT32_C(  -699.82) } }
  };

  for (size_t i = 0 ; i < (sizeof(test_vec) / sizeof(test_vec[0])) ; i++) {
    easysimd__m512 a = easysimd_mm512_loadu_ps(test_vec[i].a);
    EASYSIMD_ALIGN_LIKE_64(easysimd__m512) easysimd_float32 r[sizeof(easysimd__m512) / sizeof(easysimd_float32)];  
    EASYSIMD_TEST_PERF_WITH_LOOP_START(100000) {
      easysimd_mm512_store_ps(r, a);
    } EASYSIMD_TEST_PERF_END("easysimd_mm512_store_ps");
    easysimd_assert_equal_vf32(sizeof(r) / sizeof(r[0]), r, test_vec[i].r, 1);
  }

  return 0;
#else
  fputc('\n', stdout);
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512 a = easysimd_test_x86_random_f32x16(EASYSIMD_FLOAT32_C(-1000.0), EASYSIMD_FLOAT32_C(1000.0));
    easysimd_float32 r[sizeof(easysimd__m512) / sizeof(easysimd_float32)];
    easysimd_mm512_store_ps(r, a);

    easysimd_test_x86_write_f32x16(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_codegen_write_vf32(2, sizeof(r) / sizeof(r[0]), r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_store_pd (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const easysimd_float64 a[8];
    const easysimd_float64 r[8];
  } test_vec[] = {
    { { EASYSIMD_FLOAT64_C(  -202.39), EASYSIMD_FLOAT64_C(   -40.73), EASYSIMD_FLOAT64_C(   550.98), EASYSIMD_FLOAT64_C(   259.08),
        EASYSIMD_FLOAT64_C(  -835.09), EASYSIMD_FLOAT64_C(  -768.49), EASYSIMD_FLOAT64_C(   924.86), EASYSIMD_FLOAT64_C(   625.84) },
      { EASYSIMD_FLOAT64_C(  -202.39), EASYSIMD_FLOAT64_C(   -40.73), EASYSIMD_FLOAT64_C(   550.98), EASYSIMD_FLOAT64_C(   259.08),
        EASYSIMD_FLOAT64_C(  -835.09), EASYSIMD_FLOAT64_C(  -768.49), EASYSIMD_FLOAT64_C(   924.86), EASYSIMD_FLOAT64_C(   625.84) } },
    { { EASYSIMD_FLOAT64_C(   230.61), EASYSIMD_FLOAT64_C(   766.19), EASYSIMD_FLOAT64_C(    78.90), EASYSIMD_FLOAT64_C(   304.61),
        EASYSIMD_FLOAT64_C(   169.25), EASYSIMD_FLOAT64_C(   787.51), EASYSIMD_FLOAT64_C(  -649.02), EASYSIMD_FLOAT64_C(   774.16) },
      { EASYSIMD_FLOAT64_C(   230.61), EASYSIMD_FLOAT64_C(   766.19), EASYSIMD_FLOAT64_C(    78.90), EASYSIMD_FLOAT64_C(   304.61),
        EASYSIMD_FLOAT64_C(   169.25), EASYSIMD_FLOAT64_C(   787.51), EASYSIMD_FLOAT64_C(  -649.02), EASYSIMD_FLOAT64_C(   774.16) } },
    { { EASYSIMD_FLOAT64_C(   286.42), EASYSIMD_FLOAT64_C(   959.52), EASYSIMD_FLOAT64_C(  -526.08), EASYSIMD_FLOAT64_C(  -577.98),
        EASYSIMD_FLOAT64_C(   655.97), EASYSIMD_FLOAT64_C(   232.57), EASYSIMD_FLOAT64_C(   944.01), EASYSIMD_FLOAT64_C(   810.26) },
      { EASYSIMD_FLOAT64_C(   286.42), EASYSIMD_FLOAT64_C(   959.52), EASYSIMD_FLOAT64_C(  -526.08), EASYSIMD_FLOAT64_C(  -577.98),
        EASYSIMD_FLOAT64_C(   655.97), EASYSIMD_FLOAT64_C(   232.57), EASYSIMD_FLOAT64_C(   944.01), EASYSIMD_FLOAT64_C(   810.26) } },
    { { EASYSIMD_FLOAT64_C(  -792.28), EASYSIMD_FLOAT64_C(  -270.95), EASYSIMD_FLOAT64_C(   840.33), EASYSIMD_FLOAT64_C(  -948.89),
        EASYSIMD_FLOAT64_C(  -846.80), EASYSIMD_FLOAT64_C(   165.38), EASYSIMD_FLOAT64_C(  -264.65), EASYSIMD_FLOAT64_C(   -49.19) },
      { EASYSIMD_FLOAT64_C(  -792.28), EASYSIMD_FLOAT64_C(  -270.95), EASYSIMD_FLOAT64_C(   840.33), EASYSIMD_FLOAT64_C(  -948.89),
        EASYSIMD_FLOAT64_C(  -846.80), EASYSIMD_FLOAT64_C(   165.38), EASYSIMD_FLOAT64_C(  -264.65), EASYSIMD_FLOAT64_C(   -49.19) } },
    { { EASYSIMD_FLOAT64_C(  -875.36), EASYSIMD_FLOAT64_C(  -713.67), EASYSIMD_FLOAT64_C(  -790.11), EASYSIMD_FLOAT64_C(  -710.44),
        EASYSIMD_FLOAT64_C(  -482.16), EASYSIMD_FLOAT64_C(  -865.25), EASYSIMD_FLOAT64_C(   915.40), EASYSIMD_FLOAT64_C(   748.46) },
      { EASYSIMD_FLOAT64_C(  -875.36), EASYSIMD_FLOAT64_C(  -713.67), EASYSIMD_FLOAT64_C(  -790.11), EASYSIMD_FLOAT64_C(  -710.44),
        EASYSIMD_FLOAT64_C(  -482.16), EASYSIMD_FLOAT64_C(  -865.25), EASYSIMD_FLOAT64_C(   915.40), EASYSIMD_FLOAT64_C(   748.46) } },
    { { EASYSIMD_FLOAT64_C(   900.95), EASYSIMD_FLOAT64_C(    -5.70), EASYSIMD_FLOAT64_C(    53.07), EASYSIMD_FLOAT64_C(    70.20),
        EASYSIMD_FLOAT64_C(  -218.19), EASYSIMD_FLOAT64_C(   404.05), EASYSIMD_FLOAT64_C(  -155.65), EASYSIMD_FLOAT64_C(  -931.77) },
      { EASYSIMD_FLOAT64_C(   900.95), EASYSIMD_FLOAT64_C(    -5.70), EASYSIMD_FLOAT64_C(    53.07), EASYSIMD_FLOAT64_C(    70.20),
        EASYSIMD_FLOAT64_C(  -218.19), EASYSIMD_FLOAT64_C(   404.05), EASYSIMD_FLOAT64_C(  -155.65), EASYSIMD_FLOAT64_C(  -931.77) } },
    { { EASYSIMD_FLOAT64_C(   363.57), EASYSIMD_FLOAT64_C(   318.27), EASYSIMD_FLOAT64_C(  -509.76), EASYSIMD_FLOAT64_C(    19.55),
        EASYSIMD_FLOAT64_C(  -449.16), EASYSIMD_FLOAT64_C(  -565.74), EASYSIMD_FLOAT64_C(  -170.19), EASYSIMD_FLOAT64_C(  -241.43) },
      { EASYSIMD_FLOAT64_C(   363.57), EASYSIMD_FLOAT64_C(   318.27), EASYSIMD_FLOAT64_C(  -509.76), EASYSIMD_FLOAT64_C(    19.55),
        EASYSIMD_FLOAT64_C(  -449.16), EASYSIMD_FLOAT64_C(  -565.74), EASYSIMD_FLOAT64_C(  -170.19), EASYSIMD_FLOAT64_C(  -241.43) } },
    { { EASYSIMD_FLOAT64_C(   163.30), EASYSIMD_FLOAT64_C(  -329.86), EASYSIMD_FLOAT64_C(  -190.32), EASYSIMD_FLOAT64_C(   316.51),
        EASYSIMD_FLOAT64_C(   835.52), EASYSIMD_FLOAT64_C(   545.03), EASYSIMD_FLOAT64_C(  -732.68), EASYSIMD_FLOAT64_C(   960.16) },
      { EASYSIMD_FLOAT64_C(   163.30), EASYSIMD_FLOAT64_C(  -329.86), EASYSIMD_FLOAT64_C(  -190.32), EASYSIMD_FLOAT64_C(   316.51),
        EASYSIMD_FLOAT64_C(   835.52), EASYSIMD_FLOAT64_C(   545.03), EASYSIMD_FLOAT64_C(  -732.68), EASYSIMD_FLOAT64_C(   960.16) } }
  };

  for (size_t i = 0 ; i < (sizeof(test_vec) / sizeof(test_vec[0])) ; i++) {
    easysimd__m512d a = easysimd_mm512_loadu_pd(test_vec[i].a);
    easysimd_float64 r[sizeof(easysimd__m512) / sizeof(easysimd_float64)];
    EASYSIMD_TEST_PERF_WITH_LOOP_START(100000) {
      easysimd_mm512_store_pd(r, a);
    } EASYSIMD_TEST_PERF_END("easysimd_mm512_store_pd");
    easysimd_assert_equal_vf64(sizeof(r) / sizeof(r[0]), r, test_vec[i].r, 1);
  }

  return 0;
#else
  fputc('\n', stdout);
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512d a = easysimd_test_x86_random_f64x8(EASYSIMD_FLOAT64_C(-1000.0), EASYSIMD_FLOAT64_C(1000.0));
    easysimd_float64 r[sizeof(easysimd__m512d) / sizeof(easysimd_float64)];
    easysimd_mm512_store_pd(r, a);

    easysimd_test_x86_write_f64x8(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_codegen_write_vf64(2, sizeof(r) / sizeof(r[0]), r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

static int
test_easysimd_mm512_store_si512 (EASYSIMD_MUNIT_TEST_ARGS) {
#if 1
  static const struct {
    const int32_t a[16];
    const int32_t r[16];
  } test_vec[] = {
    { {  INT32_C(   765790194),  INT32_C(   174540463), -INT32_C(  1316563001),  INT32_C(   488900296),  INT32_C(  1873789127), -INT32_C(  2103333710),  INT32_C(  1980827330),  INT32_C(  1337916509),
        -INT32_C(  1283693821),  INT32_C(  1908270249), -INT32_C(  2094906437),  INT32_C(   295716426), -INT32_C(  1182773241), -INT32_C(  1103420932), -INT32_C(  2060169944),  INT32_C(  1289024073) },
      {  INT32_C(   765790194),  INT32_C(   174540463), -INT32_C(  1316563001),  INT32_C(   488900296),  INT32_C(  1873789127), -INT32_C(  2103333710),  INT32_C(  1980827330),  INT32_C(  1337916509),
        -INT32_C(  1283693821),  INT32_C(  1908270249), -INT32_C(  2094906437),  INT32_C(   295716426), -INT32_C(  1182773241), -INT32_C(  1103420932), -INT32_C(  2060169944),  INT32_C(  1289024073) } },
    { { -INT32_C(       44714), -INT32_C(   261047243),  INT32_C(  1249153792), -INT32_C(   530901799),  INT32_C(  1620761444),  INT32_C(   622843389),  INT32_C(  1806324514), -INT32_C(  1665630650),
         INT32_C(    77313999),  INT32_C(  1962216564),  INT32_C(  2025744799), -INT32_C(   497477251), -INT32_C(   247270412), -INT32_C(   350854712), -INT32_C(    78200651),  INT32_C(   244780607) },
      { -INT32_C(       44714), -INT32_C(   261047243),  INT32_C(  1249153792), -INT32_C(   530901799),  INT32_C(  1620761444),  INT32_C(   622843389),  INT32_C(  1806324514), -INT32_C(  1665630650),
         INT32_C(    77313999),  INT32_C(  1962216564),  INT32_C(  2025744799), -INT32_C(   497477251), -INT32_C(   247270412), -INT32_C(   350854712), -INT32_C(    78200651),  INT32_C(   244780607) } },
    { {  INT32_C(   974336710), -INT32_C(   575797186), -INT32_C(   296326031),  INT32_C(  2043719557),  INT32_C(  1785402274),  INT32_C(   693469556), -INT32_C(  2128303038), -INT32_C(  2138063942),
         INT32_C(   750428910),  INT32_C(   453666986),  INT32_C(  1493852372), -INT32_C(  1311516145),  INT32_C(  1645952749),  INT32_C(    25915839), -INT32_C(   679301091),  INT32_C(  1498944107) },
      {  INT32_C(   974336710), -INT32_C(   575797186), -INT32_C(   296326031),  INT32_C(  2043719557),  INT32_C(  1785402274),  INT32_C(   693469556), -INT32_C(  2128303038), -INT32_C(  2138063942),
         INT32_C(   750428910),  INT32_C(   453666986),  INT32_C(  1493852372), -INT32_C(  1311516145),  INT32_C(  1645952749),  INT32_C(    25915839), -INT32_C(   679301091),  INT32_C(  1498944107) } },
    { {  INT32_C(  1602622132),  INT32_C(  1333432443), -INT32_C(     5667600),  INT32_C(  1286634591),  INT32_C(  2041498554),  INT32_C(  1501248060),  INT32_C(  1429339626), -INT32_C(   995129073),
         INT32_C(   371406235), -INT32_C(  1251566139), -INT32_C(  2118906078),  INT32_C(  1171088523),  INT32_C(  1824422959), -INT32_C(  1597687370),  INT32_C(  1190524471),  INT32_C(   453682303) },
      {  INT32_C(  1602622132),  INT32_C(  1333432443), -INT32_C(     5667600),  INT32_C(  1286634591),  INT32_C(  2041498554),  INT32_C(  1501248060),  INT32_C(  1429339626), -INT32_C(   995129073),
         INT32_C(   371406235), -INT32_C(  1251566139), -INT32_C(  2118906078),  INT32_C(  1171088523),  INT32_C(  1824422959), -INT32_C(  1597687370),  INT32_C(  1190524471),  INT32_C(   453682303) } },
    { { -INT32_C(  1640944167), -INT32_C(   313288757),  INT32_C(   829294502), -INT32_C(  1686750357),  INT32_C(  1829189047), -INT32_C(  1525822354),  INT32_C(  1122763715), -INT32_C(  2124548441),
        -INT32_C(   283144412), -INT32_C(   841190618), -INT32_C(   419542406),  INT32_C(  1031894405),  INT32_C(   413829290),  INT32_C(   398374996),  INT32_C(  1650109115), -INT32_C(   991709280) },
      { -INT32_C(  1640944167), -INT32_C(   313288757),  INT32_C(   829294502), -INT32_C(  1686750357),  INT32_C(  1829189047), -INT32_C(  1525822354),  INT32_C(  1122763715), -INT32_C(  2124548441),
        -INT32_C(   283144412), -INT32_C(   841190618), -INT32_C(   419542406),  INT32_C(  1031894405),  INT32_C(   413829290),  INT32_C(   398374996),  INT32_C(  1650109115), -INT32_C(   991709280) } },
    { {  INT32_C(  1840448326), -INT32_C(   264597642),  INT32_C(  1607874777),  INT32_C(  1469863853),  INT32_C(   879773407), -INT32_C(  1186255106),  INT32_C(  2015143384), -INT32_C(  1556218019),
         INT32_C(  2014375938),  INT32_C(  1500072576),  INT32_C(   817381251),  INT32_C(  1988646039), -INT32_C(  1716848485), -INT32_C(    28051930), -INT32_C(   126455909),  INT32_C(  1906094958) },
      {  INT32_C(  1840448326), -INT32_C(   264597642),  INT32_C(  1607874777),  INT32_C(  1469863853),  INT32_C(   879773407), -INT32_C(  1186255106),  INT32_C(  2015143384), -INT32_C(  1556218019),
         INT32_C(  2014375938),  INT32_C(  1500072576),  INT32_C(   817381251),  INT32_C(  1988646039), -INT32_C(  1716848485), -INT32_C(    28051930), -INT32_C(   126455909),  INT32_C(  1906094958) } },
    { {  INT32_C(   619293860),  INT32_C(  2055033591),  INT32_C(   699020946),  INT32_C(   631190154),  INT32_C(  1354713642), -INT32_C(   615640512), -INT32_C(   271268479),  INT32_C(   476082296),
         INT32_C(   322980380),  INT32_C(   781041308),  INT32_C(  2119645428), -INT32_C(  1784350870), -INT32_C(  2115673279), -INT32_C(   161729419),  INT32_C(  1910845689), -INT32_C(  1114749280) },
      {  INT32_C(   619293860),  INT32_C(  2055033591),  INT32_C(   699020946),  INT32_C(   631190154),  INT32_C(  1354713642), -INT32_C(   615640512), -INT32_C(   271268479),  INT32_C(   476082296),
         INT32_C(   322980380),  INT32_C(   781041308),  INT32_C(  2119645428), -INT32_C(  1784350870), -INT32_C(  2115673279), -INT32_C(   161729419),  INT32_C(  1910845689), -INT32_C(  1114749280) } },
    { {  INT32_C(   751881872), -INT32_C(  2141495668),  INT32_C(    16757398), -INT32_C(   359291991),  INT32_C(  2070641414), -INT32_C(  1468938065), -INT32_C(  1726392584),  INT32_C(   743876508),
         INT32_C(    39396982),  INT32_C(   444839044),  INT32_C(   270238310),  INT32_C(   737849381), -INT32_C(   626629077),  INT32_C(   646059822),  INT32_C(   180329581), -INT32_C(  1187637949) },
      {  INT32_C(   751881872), -INT32_C(  2141495668),  INT32_C(    16757398), -INT32_C(   359291991),  INT32_C(  2070641414), -INT32_C(  1468938065), -INT32_C(  1726392584),  INT32_C(   743876508),
         INT32_C(    39396982),  INT32_C(   444839044),  INT32_C(   270238310),  INT32_C(   737849381), -INT32_C(   626629077),  INT32_C(   646059822),  INT32_C(   180329581), -INT32_C(  1187637949) } }
  };

  for (size_t i = 0 ; i < (sizeof(test_vec) / sizeof(test_vec[0])) ; i++) {
    easysimd__m512i a = easysimd_mm512_loadu_si512(test_vec[i].a);
    EASYSIMD_ALIGN_LIKE_64(easysimd__m512i) int32_t r[sizeof(easysimd__m512i) / sizeof(int32_t)];
    EASYSIMD_TEST_PERF_WITH_LOOP_START(100000) {
      easysimd_mm512_store_si512(r, a);
    } EASYSIMD_TEST_PERF_END("easysimd_mm512_store_si512");
    easysimd_assert_equal_vi32(sizeof(r) / sizeof(r[0]), r, test_vec[i].r);
  }

  return 0;
#else
  fputc('\n', stdout);
  for (int i = 0 ; i < 8 ; i++) {
    easysimd__m512i a = easysimd_test_x86_random_i32x16();
    int32_t r[sizeof(easysimd__m512i) / sizeof(int32_t)];
    easysimd_mm512_store_si512(r, a);

    easysimd_test_x86_write_i32x16(2, a, EASYSIMD_TEST_VEC_POS_FIRST);
    easysimd_test_codegen_write_vi32(2, sizeof(r) / sizeof(r[0]), r, EASYSIMD_TEST_VEC_POS_LAST);
  }
  return 1;
#endif
}

EASYSIMD_TEST_FUNC_LIST_BEGIN
EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_store_epi32)
EASYSIMD_TEST_FUNC_LIST_ENTRY(mm_store_epi64)
EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_store_ps)
EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_store_pd)
EASYSIMD_TEST_FUNC_LIST_ENTRY(mm512_store_si512)
EASYSIMD_TEST_FUNC_LIST_END

#include <test/x86/avx512/test-avx512-footer.h>
